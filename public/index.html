<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFact - Gestion des Devis et Factures</title>
    <!-- Assurez-vous que ce fichier CSS est mis à jour avec les nouveaux styles -->
    <script src="js/htmx.js" defer></script>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="js/d3.min.js"></script>
    <script src="js/plot.umd.js"></script>
<style>
        /* Auto-hide header/footer with smooth transition */
        header {
            transition: max-height 0.5s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out;
            opacity: 1;
            max-height: 500px;
            overflow: hidden;
        }
        footer.footer {
            transition: opacity 0.5s ease-in-out, max-height 0.5s ease-in-out, margin 0.5s ease-in-out;
            opacity: 1;
            max-height: 200px;
            overflow: hidden;
        }

        /* Collapsed state */
        body.autohide header {
            opacity: 0;
            max-height: 0;
            margin: 0;
            padding: 0;
        }

        body.autohide footer.footer {
            opacity: 0;
            max-height: 0;
            margin: 0;
        }

        /* Ensures main takes full available space */
        main {
            transition: padding 0.5s ease-in-out;
        }

        body.autohide main {
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
    <script>
        // Navigation handler for section switching with API calls
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('main section.view');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update nav button states
            const navButtons = document.querySelectorAll('nav .nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Activate the clicked button
            const buttonMap = {
                'viewPropals': 'navPropals',
                'viewClients': 'navClients',
                'viewTarifs': 'navTarifs',
                'viewDashboard': 'navDashboard',
                'viewConfig': 'navConfig'
            };
            const btnId = buttonMap[sectionId];
            if (btnId) {
                document.getElementById(btnId)?.classList.add('active');
            }

            // Update URL hash
            window.location.hash = sectionId;

            // Load data based on section
            loadSectionData(sectionId);

            // Trigger load event for the section (useful for data loading)
            const loadEvent = new CustomEvent('sectionLoaded', { detail: { sectionId } });
            document.dispatchEvent(loadEvent);
        }

        // Handle hash change in URL
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash) {
                showSection(hash);
            }
        });

        // Load initial section on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load app info
                const response = await fetch('/api/info');
                const info = await response.json();
                document.getElementById('name').textContent = info.name;
                document.getElementById('version').textContent = info.version;
            } catch (error) {
                console.error('Error loading app info:', error);
            }

            const hash = window.location.hash.slice(1);
            const initialSection = hash || 'viewPropals';
            showSection(initialSection);

           // Fullscreen toggle button handler with cross-browser support
            const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
            
            const toggleFullscreen = () => {
                const elem = document.documentElement;
                
                // Check if already in fullscreen
                const isFullscreen = document.fullscreenElement || 
                                    document.webkitFullscreenElement || 
                                    document.mozFullScreenElement || 
                                    document.msFullscreenElement;
                
                if (!isFullscreen) {
                    // Enter fullscreen with cross-browser support
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                            console.error(`Erreur plein écran: ${err.message}`);
                            alert('Impossible de passer en mode plein écran. Veuillez réessayer.');
                        });
                    } else if (elem.webkitRequestFullscreen) { // Safari
                        elem.webkitRequestFullscreen();
                    } else if (elem.mozRequestFullScreen) { // Firefox
                        elem.mozRequestFullScreen();
                    } else if (elem.msRequestFullscreen) { // IE/Edge
                        elem.msRequestFullscreen();
                    }
                } else {
                    // Exit fullscreen with cross-browser support
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            };

            const updateFullscreenIcon = () => {
                const isFullscreen = document.fullscreenElement || 
                                    document.webkitFullscreenElement || 
                                    document.mozFullScreenElement || 
                                    document.msFullscreenElement;
                
                if (isFullscreen) {
                    fullscreenBtn.src = 'img/reduce.svg';
                    fullscreenBtn.alt = 'Quitter le plein écran';
                    fullscreenBtn.title = 'Quitter le plein écran (Échap)';
                } else {
                    fullscreenBtn.src = 'img/expand.svg';
                    fullscreenBtn.alt = 'Plein écran';
                    fullscreenBtn.title = 'Passer en plein écran (F11)';
                }
            };
            
            // Add click event
            fullscreenBtn?.addEventListener('click', toggleFullscreen);
            
            // Listen to all fullscreen change events (cross-browser)
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
            document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
            document.addEventListener('MSFullscreenChange', updateFullscreenIcon);

            // Auto-hide header after 3 seconds
            setTimeout(() => {
                document.body.classList.add('autohide');
            }, 3000);

        });

        // Load section data from API
        async function loadSectionData(sectionId) {
            try {
                switch(sectionId) {
                    case 'viewPropals':
                        await loadSuiviData();
                        await populateClientsSelect();
                        break;
                    case 'viewClients':
                        await loadClientsData();
                        break;
                    case 'viewTarifs':
                        await loadTarifsData();
                        break;
                    case 'viewDashboard':
                        await loadDashboardData();
                        break;
                    case 'viewConfig':
                        await loadConfigData();
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Load config/settings data
        async function loadConfigData() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                // Populate form fields
                document.getElementById('configManagerName').value = settings.managerName || '';
                document.getElementById('configManagerTitle').value = settings.managerTitle || '';
                document.getElementById('configManagerPhone').value = settings.managerPhone || '';
                document.getElementById('configManagerEmailContact').value = settings.managerEmail || '';
                document.getElementById('configManagerAddress').value = settings.managerAddress || '';
                document.getElementById('configManagerCity').value = settings.managerCity || '';
                document.getElementById('configTva').value = settings.tva || 20;
                document.getElementById('configSiret').value = settings.siret || '';
                document.getElementById('configApe').value = settings.ape || '';
                document.getElementById('configAdeli').value = settings.adeli || '';
                document.getElementById('configIban').value = settings.iban || '';
                document.getElementById('configBic').value = settings.bic || '';
                document.getElementById('configTvaMention').value = settings.tvaMention || '';
                document.getElementById('configPaymentTerms').value = settings.paymentTerms || '';
                document.getElementById('configInsurance').value = settings.insurance || '';
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Populate client select dropdown
        async function populateClientsSelect() {
            try {
                const response = await fetch('/api/clients');
                const clients = await response.json();
                const select = document.getElementById('PropalClientSelect');
                
                // Clear existing options except first one
                select.innerHTML = '<option value="">-- Sélectionner un client --</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.nom} ${client.prenom}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating clients:', error);
            }
        }

        // Load suivi data
        async function loadSuiviData() {
            try {
                const response = await fetch('/api/suivi');
                const data = await response.json();
                populateSuiviTable(data);
                populateTarifsSelect();
            } catch (error) {
                console.error('Error loading suivi data:', error);
            }
        }

        // Load clients data
        async function loadClientsData() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                populateClientsTable(data);
                populateTarifsSelect();
            } catch (error) {
                console.error('Error loading clients data:', error);
            }
        }

        // Load tarifs data
        async function loadTarifsData() {
            try {
                const response = await fetch('/api/tarifs');
                const data = await response.json();
                populateTarifsTable(data);
            } catch (error) {
                console.error('Error loading tarifs data:', error);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const [clients, tarifs, suivi] = await Promise.all([
                    fetch('/api/clients').then(r => r.json()),
                    fetch('/api/tarifs').then(r => r.json()),
                    fetch('/api/suivi').then(r => r.json())
                ]);
                
                updateDashboardStats(clients, tarifs, suivi);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Populate suivi table
        function populateSuiviTable(data) {
            const tbody = document.querySelector('#PropalsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const date = new Date(item.date_heure).toLocaleDateString('fr-FR');
                row.innerHTML = `
                    <td class="id">${item.id}</td>
                    <td class="devis_number">${item.devis_number || ''}</td>
                    <td>${date}</td>
                    <td>${item.duree || ''}</td>
                    <td>${item.client_name || item.id_client || ''}</td>
                    <td>${item.id_tarifs || ''}</td>
                    <td>${parseFloat(item.montant || 0).toFixed(2)} €</td>
                    <td><span class="badge-${item.statut?.toLowerCase() || 'secondary'}">${item.statut || ''}</span></td>
                    <td>${item.mode_paiement || ''}</td>
                    <td>${item.date_paiement || ''}</td>
                    <td>${item.invoice_number || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" hx-delete="/api/suivi/${item.id}" hx-target="#viewPropals" hx-swap="innerHTML swap:1s">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate clients table
        function populateClientsTable(data) {
            const tbody = document.querySelector('#clientsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="id" style="display:none;">${item.id}</td>
                    <td>${item.nom || ""}</td>
                    <td>${item.prenom || ""}</td>
                    <td>${item.telephone || ""}</td>
                    <td>${item.email || ""}</td>
                    <td>${item.adresse || ""}</td>
                    <td>${item.ville || ""}</td>
                    <td>${item.distance || ""}</td>
                    <td>${item.notes || ""}</td>
                    <td><input type="checkbox" ${item.statut === "actif" ? "checked" : ""} disabled></td>
                    <td>${item.dateCreation ? new Date(item.dateCreation).toLocaleDateString("fr-FR") : ""}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" hx-delete="/api/clients/${item.id}" hx-target="#viewClients" hx-swap="innerHTML swap:1s">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate tarifs table
        function populateTarifsTable(data) {
            const tbody = document.querySelector('#tarifsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.libelle || ''}</td>
                    <td>${item.timeByUnits || item.duree || ''}</td>
                    <td>${parseFloat(item.montant || 0).toFixed(2)} €</td>
                    <td>
                        <button class="btn btn-sm btn-danger" hx-delete="/api/tarifs/${item.id}" hx-target="#viewTarifs" hx-swap="innerHTML swap:1s">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate tarifs select
        async function populateTarifsSelect() {
            try {
                const response = await fetch('/api/tarifs');
                const data = await response.json();
                const select = document.querySelector('#PropalTarif');
                if (!select) return;
                
                select.innerHTML = '<option value="">Sélectionner un tarif</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.libelle} - ${parseFloat(item.montant || 0).toFixed(2)} €`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tarifs for select:', error);
            }
        }

        // Update dashboard stats
        function updateDashboardStats(clients, tarifs, suivi) {
            // Update client count
            const clientCount = document.querySelector('#statClientsCount');
            if (clientCount) clientCount.textContent = clients.length;
            
            // Update propal count
            const propalCount = document.querySelector('#statPropalsCount');
            if (propalCount) propalCount.textContent = suivi.length;
            
            // Update paid count
            const paidCount = document.querySelector('#statPropalsPayees');
            if (paidCount) {
                const paid = suivi.filter(s => s.statut === 'PAYEE').length;
                paidCount.textContent = paid;
            }
            
            // Calculate revenue for different periods
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let caMoisEnCours = 0;
            let caMoisPrecedent = 0;
            let caAnneeEnCours = 0;
            let caAnneePrecedente = 0;
            
            suivi.forEach(item => {
                const date = new Date(item.date_heure);
                const amount = parseFloat(item.montant || 0);
                
                if (date.getFullYear() === currentYear) {
                    caAnneeEnCours += amount;
                    if (date.getMonth() === currentMonth) {
                        caMoisEnCours += amount;
                    }
                } else if (date.getFullYear() === currentYear - 1) {
                    caAnneePrecedente += amount;
                }
                
                if (date.getMonth() === (currentMonth - 1) && date.getFullYear() === currentYear) {
                    caMoisPrecedent += amount;
                }
            });
            
            const caMoisPrecedentEl = document.querySelector('#caMoisPrecedent');
            const caMoisEnCoursEl = document.querySelector('#caMoisEnCours');
            const caAnneeAnterieureEl = document.querySelector('#caAnneePrecedente');
            const caAnneeEnCoursEl = document.querySelector('#caAnneeEnCours');
            
            if (caMoisPrecedentEl) caMoisPrecedentEl.textContent = caMoisPrecedent.toFixed(2);
            if (caMoisEnCoursEl) caMoisEnCoursEl.textContent = caMoisEnCours.toFixed(2);
            if (caAnneeAnterieureEl) caAnneeAnterieureEl.textContent = caAnneePrecedente.toFixed(2);
            if (caAnneeEnCoursEl) caAnneeEnCoursEl.textContent = caAnneeEnCours.toFixed(2);
        }

        // Make showSection available globally
        window.showSection = showSection;
    </script>
</head>
<body>
    <header><h1><span id="name"></span> (V<span id="version"></span>)</h1></header>
    <nav>
        <div class="nav-spacer-left"></div>
        <button id="navPropals" class="nav-btn active" hx-on:click="showSection('viewPropals')">Suivi d'activite</button>
        <button id="navClients" class="nav-btn" hx-on:click="showSection('viewClients')">Clients</button>
        <button id="navTarifs" class="nav-btn" hx-on:click="showSection('viewTarifs')">Tarifs</button>
        <button id="navDashboard" class="nav-btn" hx-on:click="showSection('viewDashboard')">Tableau de Bord</button>
        <button id="navConfig" class="nav-btn" hx-on:click="showSection('viewConfig')">Config</button>
        <div class="nav-spacer-right">
            <div id="userProfileContainer" class="user-profile-container">
                <svg focusable="false" height="100%" viewBox="0 0 40 40" width="100%">
                    <defs>
                        <clipPath id="avatar-clip-path">
                            <circle cx="20" cy="20" r="16"></circle>
                        </clipPath>
                    </defs>
                    <path d="M4.02,28.27C2.73,25.8,2,22.98,2,20c0-2.87,0.68-5.59,1.88-8l-1.72-1.04C0.78,13.67,0,16.75,0,20c0,3.31,0.8,6.43,2.23,9.18L4.02,28.27z" fill="#F6AD01"></path>
                    <path d="M32.15,33.27C28.95,36.21,24.68,38,20,38c-6.95,0-12.98-3.95-15.99-9.73l-1.79,0.91C5.55,35.61,12.26,40,20,40c5.2,0,9.93-1.98,13.48-5.23L32.15,33.27z" fill="#249A41"></path>
                    <path d="M33.49,34.77C37.49,31.12,40,25.85,40,20c0-5.86-2.52-11.13-6.54-14.79l-1.37,1.46C35.72,9.97,38,14.72,38,20c0,5.25-2.26,9.98-5.85,13.27L33.49,34.77z" fill="#3174F1"></path>
                    <path d="M20,2c4.65,0,8.89,1.77,12.09,4.67l1.37-1.46C29.91,1.97,25.19,0,20,0l0,0C12.21,0,5.46,4.46,2.16,10.96L3.88,12C6.83,6.08,12.95,2,20,2" fill="#E92D18"></path>
                    <image id="svgInnerImage" class="brightness" href="img/google_disconnected.png" x="4" y="4" height="32" width="32" clip-path="url(#avatar-clip-path)"></image>
                </svg>
                
                <div id="userProfileDropdown" class="user-profile-dropdown hidden">
                    <div class="dropdown-user-info">
                        <span id="dropdownUserName" class="dropdown-user-name"></span>
                        <span id="dropdownUserEmail" class="dropdown-user-email"></span>
                    </div>
                    <hr class="dropdown-divider">
                    <button id="dropdownDisconnectBtn" class="dropdown-button">Déconnexion</button>
                </div>
            </div>
        </div>
        <img id="fullscreenToggleBtn" class="brightness" src="img/expand.svg" alt="fullScreen" style="height: 1.3em; vertical-align: middle;">
    </nav>
    <div id="dataStatusBar">
        <span id="currentDataFolder">Mode : DEMO</span>
    </div>
    <main>
        <section id="viewPropals" class="view active">
            <div class="section-header">
                <h2>Suivi d'activite</h2>
                <button id="btnAddPropal" class="btn btn-primary" hx-on:click="toggleForm('PropalFormContainer')">Ajouter un Devis</button>
            </div>
            <div id="PropalFormContainer" class="form-container hidden">
                <form id="PropalForm" class="form-grid compact">
                    <input type="hidden" id="PropalId">
                    <div class="form-group">
                        <label for="PropalClientIdInput">Client*</label><input type="hidden" id="PropalClientIdInput" name="id_client"><select id="PropalClientSelect" name="id_client" required><option value="">Sélectionner</option></select></div>
                    <div class="form-group">
                        <label for="PropalDate">Date*</label><input type="datetime-local" id="PropalDate" name="date_heure" required></div>
                    <div class="form-group">
                        <label for="PropalTarif">Tarif*</label><select id="PropalTarif" name="id_tarifs" required><option value="">Sélectionner</option></select></div>
                    <div class="form-group">
                        <label for="PropalMontant">Montant (€)</label><input type="number" id="PropalMontant" name="montant" step="0.01"></div>
                    <div class="form-group">
                        <label for="PropalStatut">Statut*</label><select id="PropalStatut" name="statut" required><option value="APAYER">À Payer</option><option value="PAYEE">Payée</option><option value="ANNULEE">Annulée</option><option value="PLANIFIEE">Planifiée</option></select></div>
                    <div class="form-group">
                        <label for="PropalModePaiement">Mode Paiement</label><input type="text" id="PropalModePaiement" name="mode_paiement"></div>
                    <div class="form-group">
                        <label for="PropalDatePaiement">Date Paiement</label><input type="date" id="PropalDatePaiement" name="date_paiement"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/suivi" hx-target="#viewPropals" hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleForm('PropalFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>

            <div class="filters">
                <input type="text" id="searchPropalClientInput" placeholder="Filtrer par nom client...">
                <select id="filterPropalStatut">
                    <option value="">Tous les statuts</option>
                    <option value="APAYER">À Payer</option>
                    <option value="PAYEE">Payée</option>
                    <option value="ANNULEE">Annulée</option>
                    <option value="PLANIFIEE">Planifiée</option>
                </select>
                <label for="filterPropalDateStart">Du:</label>
                <input type="date" id="filterPropalDateStart">
                <label for="filterPropalDateEnd">Au:</label>
                <input type="date" id="filterPropalDateEnd">
                <button id="clearPropalFilters" class="btn btn-sm btn-secondary">Effacer Filtres</button>
            </div>

            <div class="table-container">
                <table id="PropalsTable">
                    <thead>
                        <tr>
                            <th class="id">id</th>
                            <th class="devis_number">#</th>
                            <th class="date_heure">Date</th>
                            <th class="duree">Duree</th>
                            <th class="id_client">Client</th>
                            <th class="id_tarifs">details</th>
                            <th class="montant">Montant</th>
                            <th class="statut">Statut</th>
                            <th class="mode_paiement">Mode Paiement</th>
                            <th class="date_paiement">Date Paiement</th>
                            <th class="invoice_number">Facture/Devis</th>
                            <th class="actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewClients" class="view">
            <div class="section-header">
                <h2>Gestion des Clients</h2>
                <button id="btnAddClient" class="btn btn-primary" hx-on:click="toggleForm('clientFormContainer')">Ajouter un Client</button>
            </div>
            <div id="clientFormContainer" class="form-container hidden">
                <form id="clientForm" class="form-grid compact">
                    <input type="hidden" id="clientId">
                    <div class="form-group">
                        <label for="clientNom">Nom*</label><input type="text" id="clientNom" name="nom" required></div>
                    <div class="form-group">
                        <label for="clientPrenom">Prénom*</label><input type="text" id="clientPrenom" name="prenom" required></div>
                    <div class="form-group">
                        <label for="clientTelephone">Téléphone</label><input type="tel" id="clientTelephone" name="telephone" pattern="[0-9]{10}" title="Le numéro de téléphone doit contenir 10 chiffres."></div>
                    <div class="form-group">
                        <label for="clientEmail">Email</label><input type="email" id="clientEmail" name="email"></div>
                    <div class="form-group">
                        <label for="clientAdresse">Adresse</label><input type="text" id="clientAdresse" name="adresse"></div>
                    <div class="form-group">
                        <label for="clientVille">Ville</label><input type="text" id="clientVille" name="ville"></div>
                    <div class="form-group">
                        <label for="clientDistance">Distance (km)</label><input type="number" id="clientDistance" name="distance" min="0" step="any"></div>
                    <div class="form-group form-row">
                        <label for="clientNotes">Notes :</label><textarea id="clientNotes" name="notes" rows="2"></textarea></div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/clients" hx-target="#viewClients" hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleForm('clientFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>
            
            <div class="filters">
                <input type="text" id="searchClientInput" placeholder="Rechercher par nom/prénom...">
                <select id="filterClientStatut">
                    <option value="">Tous les statuts</option>
                    <option value="actif">Actif</option>
                    <option value="inactif">Inactif</option>
                </select>
            </div>

            <div class="table-container">
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th class="id" style="display:none;">ID</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Téléphone</th>
                            <th>Email</th>
                            <th>Adresse</th>
                            <th>Ville</th>
                            <th>Distance (km)</th>
                            <th>Notes</th>
                            <th class="status-cell">Actif</th>
                            <th>Date Création</th>
                            <th class="actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewTarifs" class="view">
            <div class="section-header">
                <h2>Gestion des Tarifs</h2>
                <button id="btnAddTarif" class="btn btn-primary" hx-on:click="toggleForm('tarifFormContainer')">Ajouter un Tarif</button>
            </div>
            <div id="tarifFormContainer" class="form-container hidden">
                <form id="tarifForm" class="form-grid compact">
                    <input type="hidden" id="tarifId">
                    <div class="form-group">
                        <label for="tarifLibelle">Libellé*</label>
                        <input type="text" id="tarifLibelle" name="libelle" required></div>
                    <div class="form-group">
                        <label for="tarifMontant">Montant (€)*</label>
                        <input type="number" id="tarifMontant" name="montant" step="0.01" min="0" required></div>
                    <div class="form-group">
                        <label for="tarifUnit">Unité</label>
                        <input type="text" id="tarifUnit" name="Unit" placeholder="l'une, km, heure..."></div>
                    <div class="form-group">
                        <label for="tarifType">Type</label>
                        <select id="tarifType" name="type"><option value="Presta-BNC">Presta-BNC</option><option value="Presta-BIC">Presta-BIC</option><option value="Vente-BIC">Vente-BIC</option></select></div>
                    <div class="form-group">
                        <label for="tarifTimeByUnits">Temps/Unité</label>
                        <input type="text" id="tarifTimeByUnits" name="timeByUnits" placeholder="02:30"></div>
                    <div class="form-group">
                        <label for="tarifComment">Commentaire</label>
                        <input type="text" id="tarifComment" name="Comment"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/tarifs" hx-target="#viewTarifs" hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleForm('tarifFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <table id="tarifsTable">
                    <thead><tr><th>Libellé</th><th>Durée (min)</th><th>Montant (€)</th><th class="actions-cell">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewDashboard" class="view">
            <div class="section-header">
                <h2>Tableau de Bord</h2>
                <img id="exportToSheetsBtn" src="./img/google_spreadsheet.png" class="sheets-icon" alt="Exporter vers Google Sheets" title="Exporter vers Google Sheets">
            </div>
            <div class="dashboard-row" style="display: flex; gap: 1.2rem; flex-wrap: wrap;">
                <div class="form-container" style="flex:1 1 110px; min-width:110px;">
                    <h3>Chiffres Clés</h3>
                    <ul>
                        <li>Total Clients : <span id="statClientsCount">0</span></li>
                        <li>Total devis : <span id="statPropalsCount">0</span></li>
                        <li>Total Payées : <span id="statPropalsPayees">0</span></li>
                    </ul>
                </div>
                <div class="form-container" style="flex:1 1 130px; min-width:130px;">
                    <h3>Chiffres d'affaires</h3>
                    <ul>
                        <li>Mois Précédent : <span id="caMoisPrecedent">0.00</span> €</li>
                        <li>Mois en Cours : <span id="caMoisEnCours">0.00</span> €</li>
                        <li>Année Précédente : <span id="caAnneePrecedente">0.00</span> €</li>
                        <li>Année en Cours : <span id="caAnneeEnCours">0.00</span> €</li>
                    </ul>
                </div>
            </div>
            <div class="form-container">
                <h3>Évolution d'activite</h3>
                <div class="chart-controls" style="margin-bottom: 1rem;">
                    <label for="chartPeriodSelector">Agréger par :</label>
                    <select id="chartPeriodSelector" class="form-input" style="display: inline-block; width: auto; padding: 0.375rem 0.75rem;">
                        <option value="day">Jour</option>
                        <option value="week">Semaine</option>
                        <option value="month" selected>Mois</option>
                        <option value="quarter">Trimestre</option>
                        <option value="year">Année</option>
                    </select>
                </div>
                <div id="sessionsTrendChartContainer" class="chart-container">
                    <p style="text-align:center; color:#666;">Chargement du graphique...</p>
                </div>
            </div>
            </section>

        <section id="viewConfig" class="view">
            <h2>Configuration de l'Application</h2>
            <form id="configForm" class="form-container">
                <h3>Informations du Gestionnaire</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configManagerName">Nom du gestionnaire/cabinet :</label><input type="text" id="configManagerName"></div>
                    <div class="form-group">
                        <label for="configManagerTitle">Titre/Profession :</label><input type="text" id="configManagerTitle"></div>
                    <div class="form-group form-row">
                        <label for="configManagerDescription">Description (activité) :</label><textarea id="configManagerDescription" rows="2"></textarea></div>
                    <div class="form-group">
                        <label for="configManagerPhone">Téléphone :</label><input type="tel" id="configManagerPhone"></div>
                    <div class="form-group">
                        <label for="configManagerEmailContact">Email de contact (affiché sur factures)</label><input type="email" id="configManagerEmailContact"></div>
                    <div class="form-group form-row">
                        <label for="configManagerAddress">Adresse :</label><input type="text" id="configManagerAddress"></div>
                    <div class="form-group">
                        <label for="configManagerCity">Ville :</label><input type="text" id="configManagerCity"></div>
                </div>
                <div class="form-group">
                    <label for="configGoogleCalendarId">ID du Calendrier Google à utiliser :</label>
                    <input type="text" id="configGoogleCalendarId" placeholder="primary (pour le calendrier principal)">
                    <small>Laissez "primary" pour utiliser le calendrier principal du compte Google connecté, ou spécifiez un ID de calendrier personnalisé.</small>
                </div>
                <h3>Paramètres Financiers</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configTva">Taux de TVA (%) :</label><input type="number" id="configTva" step="0.1" min="0"></div>
                </div>
                
                <h3>Informations Légales</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configSiret">SIRET :</label><input type="text" id="configSiret"></div>
                    <div class="form-group">
                        <label for="configApe">Code APE :</label><input type="text" id="configApe"></div>
                    <div class="form-group">
                        <label for="configAdeli">N° ADELI :</label><input type="text" id="configAdeli"></div>
                    <div class="form-group form-row">
                        <label for="configIban">IBAN :</label><input type="text" id="configIban"></div>
                    <div class="form-group">
                        <label for="configBic">BIC :</label><input type="text" id="configBic"></div>
                </div>
                
                <h3>Mentions pour Factures</h3>
                 <div class="form-grid config-grid">
                    <div class="form-group form-row">
                        <label for="configTvaMention">Mention TVA :</label><textarea id="configTvaMention" rows="2"></textarea></div>
                    <div class="form-group form-row">
                        <label for="configPaymentTerms">Conditions de Paiement :</label><textarea id="configPaymentTerms" rows="3"></textarea></div>
                    <div class="form-group form-row">
                        <label for="configInsurance">Assurance RCP :</label><textarea id="configInsurance" rows="2"></textarea></div>
                </div>

                <div class="form-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-success">Enregistrer la Configuration</button>
                </div>

                <h3>Connexion Compte Google (pour Email & Calendrier & Sheets)</h3>
                <div id="googleAuthStatusContainer" class="form-container" style="padding: 1rem; border: 1px solid #eee; margin-bottom:1.5rem;">
                    <p id="googleAuthStatusText">État de la connexion : Vérification...</p>
                    <div id="googleAuthScopes" style="font-size: 0.9em; margin-top: 0.5rem;"></div>
                    <button type="button" id="btnConnectGoogle" class="btn btn-primary" style="margin-right: 10px;">Connecter mon compte Google</button>
                    <button type="button" id="btnDisconnectGoogle" class="btn btn-danger" style="display:none;">Déconnecter mon compte Google</button>
                </div>
            </form>
        </section>
    </main>

<footer class="footer">
    <div class="footer-bottom" id="footer-bottom-info">
        <p>
            <span style="margin-right: 20px;"> &copy; 2025 QuickFact </span>
            <a href="https://github.com/sctfic/" target="_blank" title="GitHub" style="text-decoration: none; color: inherit; margin-right: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-top;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                V<b id="version"></b>Dev by <span style="margin-left: 20px;" id="author"></span>
            </a>            
            <a href="https://www.paypal.com/donate/?hosted_button_id=EQ9ALH8BUGS5S" target="_blank" title="Faire un don" style="text-decoration: none; color: #003087; background-color: #FFC439; margin-left: 10px; padding: 4px 12px; border-radius: 18px; display: inline-flex; align-items: center; gap: 6px; font-weight: bold; font-family: sans-serif; font-size: 0.9em; vertical-align: middle;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 48 48">
                    <g clip-path="url(#paypal_clip)">
                        <path fill="#002991" d="M38.914 13.35c0 5.574-5.144 12.15-12.927 12.15H18.49l-.368 2.322L16.373 39H7.056l5.605-36h15.095c5.083 0 9.082 2.833 10.555 6.77a9.687 9.687 0 0 1 .603 3.58z"/>
                        <path fill="#60CDFF" d="M44.284 23.7A12.894 12.894 0 0 1 31.53 34.5h-5.206L24.157 48H14.89l1.483-9 1.75-11.178.367-2.322h7.497c7.773 0 12.927-6.576 12.927-12.15 3.825 1.974 6.055 5.963 5.37 10.35z"/>
                        <path fill="#008CFF" d="M38.914 13.35C37.31 12.511 35.365 12 33.248 12h-12.64L18.49 25.5h7.497c7.773 0 12.927-6.576 12.927-12.15z"/>
                    </g>
                    <defs>
                        <clipPath id="paypal_clip">
                            <path fill="#fff" d="M7.056 3h37.35v45H7.056z"/>
                        </clipPath>
                    </defs>
                </svg>
                <span>Donate/Request</span>
            </a>
        </p>
    </div>
</footer>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h4 id="deleteModalTitle">Confirmation</h4></div>
            <div class="modal-body"><p id="deleteModalMessage">Êtes-vous sûr ?</p></div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="btn btn-danger" title="Supprimer !">Supprimer</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary">Annuler</button>
            </div>
        </div>
    </div>
    
    <script>
        // Toggle form visibility helper
        function toggleForm(formContainerId) {
            const formContainer = document.getElementById(formContainerId);
            if (formContainer) {
                formContainer.classList.toggle('hidden');
            }
        }

        // Make toggleForm available globally
        window.toggleForm = toggleForm;
    </script>
</body>
</html>