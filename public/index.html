<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFact - Gestion des Devis et Factures</title>
    <!-- Assurez-vous que ce fichier CSS est mis à jour avec les nouveaux styles -->
    <script src="js/htmx.js" defer></script>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="js/d3.min.js"></script>
    <script src="js/plot.umd.js"></script>
    <script src="js/workflow.js"></script>
    <style>
        /* Auto-hide header/footer with smooth transition */
        header {
            transition: max-height 0.5s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out;
            opacity: 1;
            max-height: 500px;
            overflow: hidden;
        }

        footer.footer {
            transition: opacity 0.5s ease-in-out, max-height 0.5s ease-in-out, margin 0.5s ease-in-out;
            opacity: 1;
            max-height: 200px;
            overflow: hidden;
        }

        /* Collapsed state */
        body.autohide header {
            opacity: 0;
            max-height: 0;
            margin: 0;
            padding: 0;
        }

        body.autohide footer.footer {
            opacity: 0;
            max-height: 0;
            margin: 0;
        }

        /* Ensures main takes full available space */
        main {
            transition: padding 0.5s ease-in-out;
        }

        body.autohide main {
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
    <script>
        // Time helpers
        function timeToMinutes(str) {
            if (!str) return 0;
            const [h, m] = str.split(':').map(Number);
            return (h || 0) * 60 + (m || 0);
        }

        function minutesToTime(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Track loaded sections to avoid unnecessary reloads
        window.loadedSections = {};
        window.activeSectionId = null;

        // Navigation handler for section switching with API calls
        function showSection(sectionId) {
            // Check if this is the active section (refresh action)
            const isActiveSection = window.activeSectionId === sectionId;
            
            // Hide all sections
            const sections = document.querySelectorAll('main section.view');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update nav button states
            const navButtons = document.querySelectorAll('nav .nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Activate the clicked button
            const buttonMap = {
                'viewPropals': 'navPropals',
                'viewClients': 'navClients',
                'viewTarifs': 'navTarifs',
                'viewDashboard': 'navDashboard',
                'viewConfig': 'navConfig'
            };
            const btnId = buttonMap[sectionId];
            if (btnId) {
                document.getElementById(btnId)?.classList.add('active');
            }

            // Update URL hash
            window.location.hash = sectionId;
            window.activeSectionId = sectionId;

            // Load data based on section:
            // - Never loaded before
            // - Click on active tab (refresh)
            if (!window.loadedSections[sectionId] || isActiveSection) {
                loadSectionData(sectionId);
                window.loadedSections[sectionId] = true;
            }

            // Trigger load event for the section (useful for data loading)
            const loadEvent = new CustomEvent('sectionLoaded', { detail: { sectionId } });
            document.dispatchEvent(loadEvent);
        }

        // Handle hash change in URL
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash) {
                showSection(hash);
            }
        });

        // Load initial section on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load app info
                const response = await fetch('/api/info');
                const info = await response.json();
                document.getElementById('name').textContent = info.name;
                document.getElementById('version').textContent = info.version;
            } catch (error) {
                console.error('Error loading app info:', error);
            }

            const hash = window.location.hash.slice(1);
            const initialSection = hash || 'viewPropals';
            showSection(initialSection);

            // Fullscreen toggle button handler with cross-browser support
            const fullscreenBtn = document.getElementById('fullscreenToggleBtn');

            const toggleFullscreen = () => {
                const elem = document.documentElement;

                // Check if already in fullscreen
                const isFullscreen = document.fullscreenElement ||
                    document.webkitFullscreenElement ||
                    document.mozFullScreenElement ||
                    document.msFullscreenElement;

                if (!isFullscreen) {
                    // Enter fullscreen with cross-browser support
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                            console.error(`Erreur plein écran: ${err.message}`);
                            alert('Impossible de passer en mode plein écran. Veuillez réessayer.');
                        });
                    } else if (elem.webkitRequestFullscreen) { // Safari
                        elem.webkitRequestFullscreen();
                    } else if (elem.mozRequestFullScreen) { // Firefox
                        elem.mozRequestFullScreen();
                    } else if (elem.msRequestFullscreen) { // IE/Edge
                        elem.msRequestFullscreen();
                    }
                } else {
                    // Exit fullscreen with cross-browser support
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            };

            const updateFullscreenIcon = () => {
                const isFullscreen = document.fullscreenElement ||
                    document.webkitFullscreenElement ||
                    document.mozFullScreenElement ||
                    document.msFullscreenElement;

                if (isFullscreen) {
                    fullscreenBtn.src = 'img/reduce.svg';
                    fullscreenBtn.alt = 'Quitter le plein écran';
                    fullscreenBtn.title = 'Quitter le plein écran (Échap)';
                } else {
                    fullscreenBtn.src = 'img/expand.svg';
                    fullscreenBtn.alt = 'Plein écran';
                    fullscreenBtn.title = 'Passer en plein écran (F11)';
                }
            };

            // Add click event
            fullscreenBtn?.addEventListener('click', toggleFullscreen);

            // Listen to all fullscreen change events (cross-browser)
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
            document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
            document.addEventListener('MSFullscreenChange', updateFullscreenIcon);

            // Auto-hide header after 3 seconds
            setTimeout(() => {
                document.body.classList.add('autohide');
            }, 3000);

            // Fermer la modale d'items en cliquant à l'extérieur
            const invoiceModal = document.getElementById('invoiceItemsModal');
            if (invoiceModal) {
                invoiceModal.addEventListener('click', function (event) {
                    // Si on clique sur le fond de la modale (l'overlay)
                    if (event.target === invoiceModal) {
                        closeInvoiceItemsModal();
                    }
                });
            }

            // OAuth2 Authentication
            initializeOAuth2();

            // Initialize delete confirmation handlers
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');

            if (confirmBtn) confirmBtn.addEventListener('click', confirmDelete);
            if (cancelBtn) cancelBtn.addEventListener('click', closeDeleteConfirm);

            // Initialize filters
            setupFilters();
        });

        // OAuth2 Authentication - Simplified
        let currentAuthState = null;

        async function initializeOAuth2() {
            const userProfileBtn = document.getElementById('userProfile');

            // Check initial auth status
            await updateUserProfile();

            // Single click handler - either login or logout
            userProfileBtn?.addEventListener('click', async () => {
                if (currentAuthState?.authenticated) {
                    // Show logout confirmation modal
                    showLogoutModal();
                } else {
                    // Directly initiate login
                    await handleGoogleLogin();
                }
            });
        }

        async function updateUserProfile() {
            try {
                const response = await fetch('/api/auth/user');
                const data = await response.json();
                currentAuthState = data;

                const svgImage = document.getElementById('svgInnerImage');
                const userProfileBtn = document.getElementById('userProfile');

                if (data.authenticated && data.user) {
                    // User is authenticated - show their avatar
                    svgImage.href = data.user.picture || 'img/google_disconnected.png';
                    userProfileBtn.title = `Cliquez pour vous déconnecter (${data.user.name})`;
                } else {
                    // Not authenticated - show default icon
                    svgImage.href = 'img/google_disconnected.png';
                    userProfileBtn.title = 'Cliquez pour vous connecter';
                }
            } catch (error) {
                console.error('Error updating user profile:', error);
            }
        }

        async function handleGoogleLogin() {
            try {
                const response = await fetch('/api/auth/google');
                const data = await response.json();

                if (data.authUrl) {
                    // Open Google OAuth consent screen in a popup
                    const width = 500;
                    const height = 600;
                    const left = window.screenX + (window.outerWidth - width) / 2;
                    const top = window.screenY + (window.outerHeight - height) / 2;

                    const popup = window.open(
                        data.authUrl,
                        'googleAuth',
                        `width=${width},height=${height},left=${left},top=${top}`
                    );

                    // Poll for authentication completion
                    const checkAuth = setInterval(async () => {
                        if (popup?.closed) {
                            clearInterval(checkAuth);
                            // Check if user is authenticated
                            await updateUserProfile();
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Error initiating Google login:', error);
            }
        }

        function showLogoutModal() {
            document.getElementById('logoutConfirmModal')?.classList.remove('hidden');
        }

        function closeLogoutModal() {
            document.getElementById('logoutConfirmModal')?.classList.add('hidden');
        }

        async function confirmLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                await updateUserProfile();
                closeLogoutModal();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Delete confirmation modal functions
        let pendingDeleteUrl = null;

        function showDeleteConfirm(title, message, url) {
            pendingDeleteUrl = url;
            document.getElementById('deleteModalTitle').textContent = title;
            document.getElementById('deleteModalMessage').textContent = message;
            document.getElementById('deleteConfirmModal')?.classList.remove('hidden');
        }

        function closeDeleteConfirm() {
            pendingDeleteUrl = null;
            document.getElementById('deleteConfirmModal')?.classList.add('hidden');
        }

        function confirmDelete() {
            if (pendingDeleteUrl) {
                htmx.ajax('DELETE', pendingDeleteUrl, { target: document.body, swap: 'none' });
                closeDeleteConfirm();
            }
        }

        // Load section data from API
        async function loadSectionData(sectionId) {
            console.log('loadSectionData', sectionId);
            try {
                switch (sectionId) {
                    case 'viewPropals':
                        await loadSuiviData();
                        await populateClientsSelect();
                        break;
                    case 'viewClients':
                        await loadClientsData();
                        break;
                    case 'viewTarifs':
                        await loadTarifsData();
                        break;
                    case 'viewDashboard':
                        await loadDashboardData();
                        break;
                    case 'viewConfig':
                        await loadConfigData();
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Load config/settings data
        async function loadConfigData() {
            console.log('loadConfigData');
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                // Populate form fields
                document.getElementById('configManagerName').value = settings.managerName || '';
                document.getElementById('configManagerTitle').value = settings.managerTitle || '';
                document.getElementById('configManagerPhone').value = settings.managerPhone || '';
                document.getElementById('configManagerEmailContact').value = settings.managerEmail || '';
                document.getElementById('configManagerAddress').value = settings.managerAddress || '';
                document.getElementById('configManagerCity').value = settings.managerCity || '';
                document.getElementById('configTva').value = settings.tva || 20;
                document.getElementById('configSiret').value = settings.siret || '';
                document.getElementById('configApe').value = settings.ape || '';
                document.getElementById('configAdeli').value = settings.adeli || '';
                document.getElementById('configIban').value = settings.iban || '';
                document.getElementById('configBic').value = settings.bic || '';
                document.getElementById('configTvaMention').value = settings.tvaMention || '';
                document.getElementById('configPaymentTerms').value = settings.paymentTerms || '';
                document.getElementById('configInsurance').value = settings.insurance || '';
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Populate client select dropdown
        async function populateClientsSelect() {
            console.log('populateClientsSelect');
            try {
                const response = await fetch('/api/clients');
                const clients = await response.json();
                const select = document.getElementById('PropalClientSelect');

                // Clear existing options except first one
                select.innerHTML = '<option value="">-- Sélectionner un client --</option>';

                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.nom} ${client.prenom}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating clients:', error);
            }
        }

        // Load suivi data
        async function loadSuiviData() {
            console.log('loadSuiviData');
            try {
                const [suiviData, tarifsData, clientsData] = await Promise.all([
                    fetch('/api/suivi').then(r => r.json()),
                    fetch('/api/tarifs').then(r => r.json()),
                    fetch('/api/clients').then(r => r.json())
                ]);
                window.availableTarifs = tarifsData;
                window.availableClients = clientsData;
                window.propalData = suiviData; // Store globally for filtering

                // Apply filters (which includes sorting and population)
                if (window.applyPropalFilters) window.applyPropalFilters();
                else populateSuiviTable(suiviData, tarifsData);

                populateTarifsSelect(tarifsData);
            } catch (error) {
                console.error('Error loading suivi data:', error);
            }
        }

        // Load clients data
        async function loadClientsData() {
            console.log('loadClientsData');
            try {
                const [clientsData, tarifsData] = await Promise.all([
                    fetch('/api/clients').then(r => r.json()),
                    fetch('/api/tarifs').then(r => r.json())
                ]);
                window.clientData = clientsData;
                window.availableClients = clientsData;
                window.availableTarifs = tarifsData;

                // Apply filters (includes sorting and population)
                if (window.applyClientFilters) window.applyClientFilters();
                else populateClientsTable(clientsData);

                populateTarifsSelect();
            } catch (error) {
                console.error('Error loading clients data:', error);
            }
        }

        // Load tarifs data
        async function loadTarifsData() {
            console.log('loadTarifsData');
            try {
                const response = await fetch('/api/tarifs');
                const data = await response.json();
                window.tarifData = data;
                window.availableTarifs = data;

                // Apply filters (includes sorting and population)
                if (window.applyTarifFilters) window.applyTarifFilters();
                else populateTarifsTable(data);

            } catch (error) {
                console.error('Error loading tarifs data:', error);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            console.log('loadDashboardData');
            try {
                const [clients, tarifs, suivi] = await Promise.all([
                    fetch('/api/clients').then(r => r.json()),
                    fetch('/api/tarifs').then(r => r.json()),
                    fetch('/api/suivi').then(r => r.json())
                ]);

                updateDashboardStats(clients, tarifs, suivi);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Helper to map string status to numeric workflow ID
        function mapStatusToId(status) {
            if (!status) return 0;
            const s = status.toUpperCase();
            if (s.includes('BROUILLON')) return 0;
            if (s.includes('ENVOY')) return 1;
            if (s.includes('PERDU')) return 2;
            if (s.includes('GAGN')) return 3;
            if (s.includes('EFFECTU')) return 4;
            if (s.includes('À PAYER') || s.includes('A PAYER')) return 6;
            if (s.includes('RELANC')) return 7;
            if (s.includes('PAY')) return 9;
            return 0;
        }

        // Populate suivi table
        function populateSuiviTable(data, tarifs = []) {
            console.log('populateSuiviTable');
            const tbody = document.querySelector('#PropalsTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const date = new Date(item.date_heure).toLocaleDateString('fr-FR');

                // Calculs dynamiques
                let totalDureeMins = 0;
                let totalMontant = 0;
                let hasItems = false;

                let itemsMap = {};
                try {
                    if (item.id_tarifs && item.id_tarifs !== 'undefined') {
                        itemsMap = typeof item.id_tarifs === 'string' ? JSON.parse(item.id_tarifs) : item.id_tarifs;
                    }
                } catch (e) { }

                if (itemsMap && Object.keys(itemsMap).length > 0 && tarifs.length > 0) {
                    hasItems = true;
                    Object.entries(itemsMap).forEach(([tid, details]) => {
                        const t = tarifs.find(x => x.id === tid);
                        if (t) {
                            const q = details.qtt || 0;
                            totalMontant += parseFloat(t.prix || 0) * q;
                            totalDureeMins += timeToMinutes(t.timeByUnits || t.duree || '00:00') * q;
                        }
                    });
                }

                const displayMontant = hasItems ? totalMontant.toFixed(2) : parseFloat(item.montant || 0).toFixed(2);
                const displayDuree = hasItems ? minutesToTime(totalDureeMins) : (item.duree || '00:00');

                const workflowId = `workflow-${item.id}`;

                row.addEventListener('dblclick', function () { editPropalRow(this, item.id); });

                row.innerHTML = `
                    <td class="id">${item.id}</td>
                    <td class="devis_number">${item.devis_number || ''}</td>
                    <td>${date}</td>
                    <td>${displayDuree}</td>
                    <td class="id_client">${item.client_name || item.id_client || ''}</td>
                    <td class="id_tarifs">[...]</td>
                    <td>${displayMontant} €</td>
                    <td style="padding: 0; min-width: 290px;"><div id="${workflowId}" style="transform: scale(0.95); transform-origin: left center;"></div></td>
                    <td>${item.mode_paiement || ''}</td>
                    <td>${item.date_paiement || ''}</td>
                    <td>${item.invoice_number || ''}</td>
                    <td class="actions-cell">
                        <button class="btn-icon" title="Dupliquer" onclick="/* TODO: duplicate logic */">
                            <svg viewBox="0 0 18 18"><path d="M8 7v7h5V7H8zM3.99 2h7.942v2H4.985v8H3V2.995A1 1 0 0 1 3.99 2zM6 5.996c0-.55.446-.996.998-.996h7.004c.55 0 .998.445.998.996v9.008c0 .55-.446.996-.998.996H6.998A.996.996 0 0 1 6 15.004V5.996z" fill-rule="evenodd"></path></svg>
                        </button>
                        <button class="btn-icon" title="Supprimer" onclick="deletePropal('${item.id}')">
                            <svg viewBox="0 0 18 18"><path d="M6.5 3c0-.552.444-1 1-1h3c.552 0 1 .444 1 1H15v2H3V3h3.5zM4 6h10v8c0 1.105-.887 2-2 2H6c-1.105 0-2-.887-2-2V6z" fill-rule="evenodd"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                // Initialize workflow visualization
                const statusId = mapStatusToId(item.statut);
                setTimeout(() => {
                    if (typeof workflow === 'function') {
                        // Determine relevant date for checks
                        let comparisonDate = item.date_heure;
                        // For payment check, we might want date_emission or date_echeance if available,
                        // otherwise date_heure matches creation.
                        // item.date_paiement is mostly for successful payment.
                        // For 'Relancer', we check if we are waiting for payment too long.

                        workflow(workflowId, statusId, {
                            date: comparisonDate,
                            onCheckboxChange: async (checked, s) => {
                                console.log('Checkbox changed for', item.id, checked);

                                let newStatusString = null;
                                // Logique de transition d'état basée sur la case cochée
                                if (checked) {
                                    if (s === 1) newStatusString = 'GAGNEE';
                                    else if (s === 6) newStatusString = 'PAYEE';
                                    else if (s === 7) newStatusString = 'PAYEE';
                                } else {
                                    // Retour en arrière
                                    if (s === 1) newStatusString = 'ENVOYEE'; // On décoche Gagné (depuis Gagné) ou Perdu?
                                    else if (s === 6) newStatusString = 'A PAYER'; // On décoche Payée
                                }

                                if (newStatusString) {
                                    try {
                                        const response = await fetch(`/api/suivi/${item.id}`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ statut: newStatusString })
                                        });

                                        if (response.ok) {
                                            // Recharger les données pour mettre à jour l'affichage
                                            loadSuiviData();
                                        } else {
                                            console.error('Erreur mise à jour statut');
                                        }
                                    } catch (err) {
                                        console.error('Erreur réseau mise à jour statut', err);
                                    }
                                }
                            },
                            onEmailClick: async (s) => {
                                console.log('Email clicked for', item.id, s);
                                let newStatusString = null;

                                // Si étape 4 (Effectué) -> on envoie la facture -> devient À PAYER (6)
                                if (s === 4) newStatusString = 'A PAYER';

                                // Si étape 0 (Brouillon) -> on envoie le devis -> devient ENVOYEE (1)
                                if (s === 0) newStatusString = 'ENVOYEE';

                                // Si étape 7 (Relancer) -> on renvoie la facture -> reste À PAYER (6) ou spécifique
                                if (s === 7) newStatusString = 'A PAYER';

                                if (newStatusString) {
                                    try {
                                        const response = await fetch(`/api/suivi/${item.id}`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ statut: newStatusString })
                                        });
                                        if (response.ok) loadSuiviData();
                                    } catch (err) {
                                        console.error('Erreur réseau update statut email', err);
                                    }
                                }
                            }
                        });
                    }
                }, 0);
            });
        }

        // Populate clients table
        function populateClientsTable(data) {
            console.log('populateClientsTable');
            const tbody = document.querySelector('#clientsTable tbody');
            if (!tbody) return;

            // Create context menu if it doesn't exist
            if (!document.getElementById('clientContextMenu')) {
                const menu = document.createElement('div');
                menu.id = 'clientContextMenu';
                menu.className = 'context-menu hidden';
                menu.style.position = 'fixed'; // Fixed to viewport
                menu.style.zIndex = '10000';
                menu.style.background = '#fff';
                menu.style.border = '1px solid #ccc';
                menu.style.boxShadow = '2px 2px 5px rgba(0,0,0,0.2)';
                menu.style.padding = '5px 0';
                menu.style.borderRadius = '4px';

                const item = document.createElement('div');
                item.innerText = 'Faire une propal';
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.fontSize = '14px';
                item.onmouseover = () => item.style.backgroundColor = '#f0f0f0';
                item.onmouseout = () => item.style.backgroundColor = 'transparent';

                item.onclick = () => {
                    const clientId = menu.dataset.clientId;
                    if (clientId) {
                        createPropalForClient(clientId);
                    }
                    menu.classList.add('hidden');
                };

                menu.appendChild(item);
                document.body.appendChild(menu);

                // Global click to close menu
                document.addEventListener('click', () => {
                    menu.classList.add('hidden');
                });
                // Close on scroll too?
            }

            const menu = document.getElementById('clientContextMenu');

            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.addEventListener('dblclick', function () { editClientRow(this, item.id); });

                // Right click handler
                row.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    menu.dataset.clientId = item.id;
                    menu.style.top = `${e.clientY}px`;
                    menu.style.left = `${e.clientX}px`;
                    menu.classList.remove('hidden');
                });

                row.innerHTML = `
                    <td class="id" style="display:none;">${item.id}</td>
                    <td>${item.nom || ""}</td>
                    <td>${item.prenom || ""}</td>
                    <td>${item.telephone || ""}</td>
                    <td>${item.email || ""}</td>
                    <td>${item.adresse || ""}</td>
                    <td>${item.ville || ""}</td>
                    <td>${item.distance || ""}</td>
                    <td>${item.notes || ""}</td>
                    <td><input type="checkbox" ${item.statut === "actif" ? "checked" : ""} disabled></td>
                    <td>${item.dateCreation ? new Date(item.dateCreation).toLocaleDateString("fr-FR") : ""}</td>
                    <td class="actions-cell">
                        <button class="btn-icon" title="Faire une propal" onclick="createPropalForClient('${item.id}')">
                            <svg viewBox="0 0 18 18"><path d="M2 13.12l8.49-8.488 2.878 2.878L4.878 16H2v-2.88zm13.776-8.017L14.37 6.507 11.494 3.63l1.404-1.406c.3-.3.783-.3 1.083 0l1.8 1.796c.3.3.3.784 0 1.083z" fill-rule="evenodd"></path></svg>
                        </button>
                        <button class="btn-icon" title="Supprimer" onclick="deleteClient('${item.id}')">
                            <svg viewBox="0 0 18 18"><path d="M6.5 3c0-.552.444-1 1-1h3c.552 0 1 .444 1 1H15v2H3V3h3.5zM4 6h10v8c0 1.105-.887 2-2 2H6c-1.105 0-2-.887-2-2V6z" fill-rule="evenodd"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate tarifs table
        // Populate tarifs table
        function populateTarifsTable(data) {
            console.log('populateTarifsTable');
            const tbody = document.querySelector('#tarifsTable tbody');
            if (!tbody) return;

            // Create context menu if it doesn't exist
            if (!document.getElementById('tarifContextMenu')) {
                const menu = document.createElement('div');
                menu.id = 'tarifContextMenu';
                menu.className = 'context-menu hidden';
                menu.style.position = 'fixed';
                menu.style.zIndex = '10000';
                menu.style.background = '#fff';
                menu.style.border = '1px solid #ccc';
                menu.style.boxShadow = '2px 2px 5px rgba(0,0,0,0.2)';
                menu.style.padding = '5px 0';
                menu.style.borderRadius = '4px';

                const setDefaultItem = document.createElement('div');
                setDefaultItem.innerText = 'Définir comme tarif par défaut';
                setDefaultItem.style.padding = '8px 12px';
                setDefaultItem.style.cursor = 'pointer';
                setDefaultItem.style.fontSize = '14px';
                setDefaultItem.onmouseover = () => setDefaultItem.style.backgroundColor = '#f0f0f0';
                setDefaultItem.onmouseout = () => setDefaultItem.style.backgroundColor = 'transparent';

                setDefaultItem.onclick = () => {
                    const tarifId = menu.dataset.tarifId;
                    if (tarifId) {
                        setDefaultTarif(tarifId);
                    }
                    menu.classList.add('hidden');
                };

                menu.appendChild(setDefaultItem);
                document.body.appendChild(menu);

                // Global click to close menu
                document.addEventListener('click', () => {
                    menu.classList.add('hidden');
                });
            }

            const menu = document.getElementById('tarifContextMenu');

            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const isDefault = item.default && (item.default === 'true' || item.default === 'True' || item.default === '1');
                
                // Apply bold styling if default
                if (isDefault) {
                    row.style.fontWeight = 'bold';
                }
                
                // Double-click to edit
                row.addEventListener('dblclick', function () { editTarifRow(this, item.id); });

                // Right-click to show context menu
                row.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    menu.dataset.tarifId = item.id;
                    menu.style.top = `${e.clientY}px`;
                    menu.style.left = `${e.clientX}px`;
                    menu.classList.remove('hidden');
                });

                row.innerHTML = `
                    <td>${item.libelle || ''}</td>
                    <td>${item.timeByUnits || item.duree || ''}</td>
                    <td>${parseFloat(item.prix || 0).toFixed(2)} €</td>
                    <td>${item.Unit || ''}</td>
                    <td>${item.type || ''}</td>
                    <td>${item.Comment || ''}</td>
                    <td class="actions-cell">
                        ${isDefault ? '<span style="font-size:12px; background:#4CAF50; color:white; padding:2px 6px; border-radius:3px;">★ Défaut</span>' : ''}
                        <button class="btn-icon" title="Supprimer" onclick="deleteTarif('${item.id}')">
                            <svg viewBox="0 0 18 18"><path d="M6.5 3c0-.552.444-1 1-1h3c.552 0 1 .444 1 1H15v2H3V3h3.5zM4 6h10v8c0 1.105-.887 2-2 2H6c-1.105 0-2-.887-2-2V6z" fill-rule="evenodd"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function setDefaultTarif(tarifId) {
            try {
                // Get all tarifs
                const response = await fetch('/api/tarifs');
                const tarifs = await response.json();

                // Update all tarifs to remove default status
                for (const tarif of tarifs) {
                    await fetch(`/api/tarifs/${tarif.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            ...tarif, 
                            default: tarif.id === tarifId ? 'true' : '' 
                        })
                    });
                }

                // Refresh table
                loadTarifsData();
            } catch (error) {
                console.error('Error setting default tarif:', error);
                alert('Erreur lors de la définition du tarif par défaut');
            }
        }

        // Populate tarifs select
        async function populateTarifsSelect(providedData = null) {
            try {
                let data = providedData;
                if (!data) {
                    const response = await fetch('/api/tarifs');
                    data = await response.json();
                    window.availableTarifs = data;
                }
                const select = document.querySelector('#PropalTarif');
                if (!select) return;

                select.innerHTML = '<option value="">Sélectionner un tarif</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.libelle} - ${parseFloat(item.prix || 0).toFixed(2)} €`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tarifs for select:', error);
            }
        }

        // Update dashboard stats
        function updateDashboardStats(clients, tarifs, suivi) {
            // Update client count
            const clientCount = document.querySelector('#statClientsCount');
            if (clientCount) clientCount.textContent = clients.length;

            // Update propal count
            const propalCount = document.querySelector('#statPropalsCount');
            if (propalCount) propalCount.textContent = suivi.length;

            // Update paid count
            const paidCount = document.querySelector('#statPropalsPayees');
            if (paidCount) {
                const paid = suivi.filter(s => s.statut === 'PAYEE').length;
                paidCount.textContent = paid;
            }

            // Calculate revenue for different periods
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let caMoisEnCours = 0;
            let caMoisPrecedent = 0;
            let caAnneeEnCours = 0;
            let caAnneePrecedente = 0;

            suivi.forEach(item => {
                const date = new Date(item.date_heure);
                const amount = parseFloat(item.montant || 0);

                if (date.getFullYear() === currentYear) {
                    caAnneeEnCours += amount;
                    if (date.getMonth() === currentMonth) {
                        caMoisEnCours += amount;
                    }
                } else if (date.getFullYear() === currentYear - 1) {
                    caAnneePrecedente += amount;
                }

                if (date.getMonth() === (currentMonth - 1) && date.getFullYear() === currentYear) {
                    caMoisPrecedent += amount;
                }
            });

            const caMoisPrecedentEl = document.querySelector('#caMoisPrecedent');
            const caMoisEnCoursEl = document.querySelector('#caMoisEnCours');
            const caAnneeAnterieureEl = document.querySelector('#caAnneePrecedente');
            const caAnneeEnCoursEl = document.querySelector('#caAnneeEnCours');

            if (caMoisPrecedentEl) caMoisPrecedentEl.textContent = caMoisPrecedent.toFixed(2);
            if (caMoisEnCoursEl) caMoisEnCoursEl.textContent = caMoisEnCours.toFixed(2);
            if (caAnneeAnterieureEl) caAnneeAnterieureEl.textContent = caAnneePrecedente.toFixed(2);
            if (caAnneeEnCoursEl) caAnneeEnCoursEl.textContent = caAnneeEnCours.toFixed(2);
        }

        // Ouvre la modale d'édition des items de la facture
        window.openInvoiceItemsModal = async function (suiviId, devisNumber) {
            const modal = document.getElementById('invoiceItemsModal');
            if (!modal) return;

            // Stocker l'ID pour les actions futures
            modal.dataset.suiviId = suiviId;

            // Mettre à jour le titre de la modale
            const modalTitle = document.getElementById('invoiceItemsModalTitle');
            modalTitle.textContent = `Édition des lignes du Devis #${devisNumber || 'N/A'}`;

            const tbody = modal.querySelector('#invoiceItemsTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Chargement...</td></tr>';

            // Afficher la modale
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);

            try {
                // Charger les tarifs et le suivi en parallèle
                const [tarifsRes, suiviRes] = await Promise.all([
                    fetch('/api/tarifs'),
                    fetch(`/api/suivi/${suiviId}`)
                ]);

                if (!tarifsRes.ok || !suiviRes.ok) throw new Error("Erreur chargement données");

                const tarifs = await tarifsRes.json();
                const suivi = await suiviRes.json();

                // Stocker les tarifs globalement pour l'usage dans addInvoiceItem
                window.availableTarifs = tarifs;

                tbody.innerHTML = '';

                // Parser les items existants (format JSON dans id_tarifs)
                let itemsMap = {};
                try {
                    if (suivi.id_tarifs && suivi.id_tarifs !== 'undefined') {
                        // Gérer le cas où id_tarifs est déjà un objet ou une string
                        itemsMap = typeof suivi.id_tarifs === 'string' ? JSON.parse(suivi.id_tarifs) : suivi.id_tarifs;
                    }
                } catch (e) {
                    console.warn('Erreur parsing id_tarifs', e);
                    itemsMap = {};
                }

                // Convertir la map en liste pour l'affichage
                // Map format: { tarifId: { qtt: number, detail: string } }
                let hasItems = false;
                if (itemsMap && typeof itemsMap === 'object') {
                    Object.entries(itemsMap).forEach(([tarifId, itemData]) => {
                        const tarif = tarifs.find(t => t.id === tarifId);
                        // Même si le tarif n'existe plus, on essaie d'afficher quelque chose si possible, ou on ignore les orphelins
                        if (tarif) {
                            addInvoiceItemRow(tbody, tarif, itemData.qtt || 1, itemData.detail || '');
                            hasItems = true;
                        }
                    });
                }

                if (!hasItems) {
                    // Si pas d'items, on peut laisser vide ou ajouter une ligne vide par défaut ?
                    // Laissons vide pour l'instant.
                }

            } catch (error) {
                console.error('Erreur:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;">Erreur lors du chargement des données</td></tr>';
            }
        }

        // Helper pour créer le select de tarifs
        function createTarifSelect(selectedId = '') {
            const select = document.createElement('select');
            select.classList.add('form-input', 'tarif-select');
            select.style.width = "100%";
            select.innerHTML = '<option value="">-- Choisir un tarif --</option>';

            if (window.availableTarifs) {
                window.availableTarifs.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    // Format: "Libellé | Durée (min) | Prix (€)"
                    const duration = t.timeByUnits || t.duree || '?';
                    const amount = parseFloat(t.prix || 0).toFixed(2);
                    option.textContent = `${t.libelle} | ${duration} min | ${amount} €`;
                    if (t.id === selectedId) option.selected = true;
                    // Stocker le prix dans data attribute pour accès facile
                    option.dataset.price = amount;
                    select.appendChild(option);
                });
            }

            select.onchange = function () {
                const row = this.closest('tr');
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.dataset.price || '0.00';
                row.querySelector('.price-cell').textContent = price + ' €';
            };

            return select;
        }

        // Helper pour ajouter une ligne
        function addInvoiceItemRow(tbody, tarif = null, qtt = 1, detail = '') {
            const row = document.createElement('tr');

            // Quantité
            const qttCell = document.createElement('td');
            qttCell.innerHTML = `<input type="number" class="form-input qtt-input" value="${qtt}" min="1" style="width: 36px;">`;

            // Tarif
            const tarifCell = document.createElement('td');
            const select = createTarifSelect(tarif ? tarif.id : '');
            tarifCell.appendChild(select);

            // Détail
            const detailCell = document.createElement('td');
            detailCell.innerHTML = `<input type="text" class="form-input detail-input" value="${detail}" placeholder="Détail optionnel">`;

            // Prix
            const priceCell = document.createElement('td');
            priceCell.className = 'price-cell';
            priceCell.style.textAlign = 'right';
            const price = tarif ? parseFloat(tarif.prix || 0).toFixed(2) : '0.00';
            priceCell.textContent = price + ' €';

            // Actions
            const actionCell = document.createElement('td');
            actionCell.style.textAlign = 'center';
            actionCell.innerHTML = `
                <button class="btn-icon" title="Supprimer la ligne" onclick="this.closest('tr').remove()">
                    <svg viewBox="0 0 18 18"><path d="M6.5 3c0-.552.444-1 1-1h3c.552 0 1 .444 1 1H15v2H3V3h3.5zM4 6h10v8c0 1.105-.887 2-2 2H6c-1.105 0-2-.887-2-2V6z" fill-rule="evenodd"></path></svg>
                </button>
            `;

            row.appendChild(qttCell);
            row.appendChild(tarifCell);
            row.appendChild(detailCell);
            row.appendChild(priceCell);
            row.appendChild(actionCell);

            tbody.appendChild(row);
        }

        // Affiche la modale d'édition
        function showInvoiceItemsModal() {
            const modal = document.getElementById('invoiceItemsModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // Ferme la modale d'édition
        function closeInvoiceItemsModal() {
            const modal = document.getElementById('invoiceItemsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Ajoute un item dans la modale (appelé par le bouton)
        function addInvoiceItem() {
            const tbody = document.querySelector('#invoiceItemsTable tbody');
            addInvoiceItemRow(tbody);
        }

        // Sauvegarde les changements de la modale
        async function saveInvoiceItems() {
            const modal = document.getElementById('invoiceItemsModal');
            const suiviId = modal.dataset.suiviId;
            const tbody = modal.querySelector('#invoiceItemsTable tbody');
            const rows = tbody.querySelectorAll('tr');

            const itemsMap = {};

            rows.forEach(row => {
                const select = row.querySelector('.tarif-select');
                // Ignorer les lignes de chargement ou d'erreur qui n'ont pas de select
                if (!select) return;

                const tarifId = select.value;
                if (!tarifId) return; // Ignorer si pas de tarif sélectionné

                const qtt = parseInt(row.querySelector('.qtt-input').value) || 0;
                const detail = row.querySelector('.detail-input').value || '';

                // Note: La structure actuelle clé=tarifId ne supporte pas plusieurs lignes du même tarif.
                // Si l'utilisateur en met plusieurs, la dernière gagnera.
                itemsMap[tarifId] = {
                    qtt: qtt,
                    detail: detail
                };
            });

            console.log('Sauvegarde des items pour suivi ID:', suiviId, itemsMap);

            try {
                const response = await fetch(`/api/suivi/${suiviId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_tarifs: JSON.stringify(itemsMap)
                    })
                });

                if (response.ok) {
                    closeInvoiceItemsModal();
                    // Recharger les données du tableau de suivi pour mettre à jour les colonnes si nécessaire
                    if (typeof loadSuiviData === 'function') {
                        loadSuiviData();
                    }
                } else {
                    const err = await response.json();
                    alert('Erreur lors de la sauvegarde: ' + (err.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                alert('Erreur de connexion lors de la sauvegarde');
            }
        }

        // --- Gestion Inline Tarifs ---

        function addTarifRow() {
            console.log('addTarifRow');
            // Save/Close existing edit first
            if (window.currentEditingRow) {
                const table = window.currentEditingRow.closest('table');
                if (table) {
                    if (table.id === 'tarifsTable') saveTarifRow(window.currentEditingRow);
                    else if (table.id === 'clientsTable') saveClientRow(window.currentEditingRow);
                    else if (table.id === 'PropalsTable') savePropalRow(window.currentEditingRow);
                }
            }

            const tbody = document.querySelector('#tarifsTable tbody');
            const row = document.createElement('tr');
            row.classList.add('editing-row');
            row.innerHTML = `
                <td><input type="text" name="libelle" class="form-input" placeholder="Libellé" required></td>
                <td><input type="text" name="timeByUnits" class="form-input" placeholder="HH:MM"></td>
                <td><input type="number" name="prix" class="form-input" step="0.01" placeholder="Prix"></td>
                <td><input type="text" name="Unit" class="form-input" placeholder="Unité"></td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <select name="type" class="form-input">
                            <option value="Presta-BNC">Presta-BNC</option>
                            <option value="Presta-BIC">Presta-BIC</option>
                            <option value="Vente-BIC">Vente-BIC</option>
                        </select>
                        <span class="help-icon" title="Presta-BNC : Activités libérales/intellectuelles (conseil, dev, etc.).&#10;Presta-BIC : Services commerciaux/artisanaux (réparation, livraison, etc.).&#10;Vente-BIC : Achat-revente de marchandises (e-commerce, boutique, etc.).">?</span>
                    </div>
                </td>
                <td><input type="text" name="Comment" class="form-input" placeholder="Commentaire"></td>
                <td class="actions-cell">
                    <button class="btn-icon" title="Sauvegarder" onclick="saveTarifRow(this.closest('tr'))">
                       <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </button>
                    <button class="btn-icon" title="Annuler" onclick="loadTarifsData()">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </td>
            `;
            tbody.prepend(row);
            window.currentEditingRow = row;
            row.querySelector('input[name="libelle"]').focus();
        }

        function editTarifRow(row, id) {
            console.log('editTarifRow', id);
            enterEditMode(row, () => {
                const data = window.availableTarifs.find(t => t.id === id);
                if (!data) return;

                row.dataset.id = id;
                row.innerHTML = `
                    <td><input type="text" name="libelle" class="form-input" value="${data.libelle || ''}"></td>
                    <td><input type="text" name="timeByUnits" class="form-input" value="${data.timeByUnits || data.duree || ''}" placeholder="HH:MM"></td>
                    <td><input type="number" name="prix" class="form-input" step="0.01" value="${data.prix || 0}"></td>
                    <td><input type="text" name="Unit" class="form-input" value="${data.Unit || ''}"></td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <select name="type" class="form-input">
                                <option value="Presta-BNC" ${data.type === 'Presta-BNC' ? 'selected' : ''}>Presta-BNC</option>
                                <option value="Presta-BIC" ${data.type === 'Presta-BIC' ? 'selected' : ''}>Presta-BIC</option>
                                <option value="Vente-BIC" ${data.type === 'Vente-BIC' ? 'selected' : ''}>Vente-BIC</option>
                            </select>
                            <span class="help-icon" title="Presta-BNC : Activités libérales/intellectuelles (conseil, dev, etc.).&#10;Presta-BIC : Services commerciaux/artisanaux (réparation, livraison, etc.).&#10;Vente-BIC : Achat-revente de marchandises (e-commerce, boutique, etc.).">?</span>
                        </div>
                    </td>
                    <td><input type="text" name="Comment" class="form-input" value="${data.Comment || ''}"></td>
                    <td class="actions-cell">
                        <button class="btn-icon" title="Sauvegarder" onclick="saveTarifRow(this.closest('tr'))">
                           <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </button>
                        <button class="btn-icon" title="Annuler" onclick="loadTarifsData()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </td>
                 `;
            });
        }

        async function saveTarifRow(row) {
            console.log('saveTarifRow');
            const id = row.dataset.id;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/tarifs/${id}` : '/api/tarifs';

            const payload = {};
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                payload[input.name] = input.value;
            });

            if (!payload.libelle || !payload.prix) {
                alert("Le libellé et le prix sont obligatoires.");
                return;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    window.currentEditingRow = null;
                    loadTarifsData(); // Refresh table
                } else {
                    const err = await response.json();
                    alert("Erreur: " + (err.message || "Erreur inconnue"));
                }
            } catch (e) {
                console.error(e);
                alert("Erreur de connexion.");
            }
        }

        // Global Editing State
        window.currentEditingRow = null;

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && window.currentEditingRow) {
                cancelEditing(window.currentEditingRow);
            }
        });

        document.addEventListener('click', function (event) {
            if (window.currentEditingRow) {
                // If click is outside the editing row
                // Note: We must also check if click is inside the modal (for propal details)
                // If clicking in modal, we shouldn't trigger save/cancel of the row.
                const modal = document.getElementById('invoiceItemsModal');
                const isClickInModal = modal && !modal.classList.contains('hidden') && modal.contains(event.target);

                if (!window.currentEditingRow.contains(event.target) && !isClickInModal) {
                    const row = window.currentEditingRow;

                    // Validate
                    if (validateRow(row)) {
                        // Valid -> Save
                        const table = row.closest('table');
                        if (table) {
                            if (table.id === 'tarifsTable') saveTarifRow(row);
                            else if (table.id === 'clientsTable') saveClientRow(row);
                            else if (table.id === 'PropalsTable') savePropalRow(row);
                        }
                    } else {
                        // Invalid
                        if (row.dataset.warned === 'true') {
                            // Second click -> Abandon
                            cancelEditing(row);
                        } else {
                            // First click -> Flash
                            row.dataset.warned = 'true';
                            // Flashing handling is inside validateRow or here?
                            // validateRow flashes.
                        }
                    }
                }
            }
        });

        function cancelEditing(row) {
            console.log('cancelEditing');
            const table = row.closest('table');
            window.currentEditingRow = null;
            if (table) {
                if (table.id === 'tarifsTable') loadTarifsData();
                else if (table.id === 'clientsTable') loadClientsData();
                else if (table.id === 'PropalsTable') loadSuiviData();
            }
        }

        function validateRow(row) {
            console.log('validateRow', row);
            let isValid = true;
            const table = row.closest('table');
            console.log('table', table);
            const inputsToFlash = [];

            if (table.id === 'tarifsTable') {
                const libelle = row.querySelector('input[name="libelle"]');
                const prix = row.querySelector('input[name="prix"]');
                if (!libelle.value.trim()) { isValid = false; inputsToFlash.push(libelle); }
                if (!prix.value) { isValid = false; inputsToFlash.push(prix); }
            }
            else if (table.id === 'clientsTable') {
                const nom = row.querySelector('input[name="nom"]');
                const prenom = row.querySelector('input[name="prenom"]');
                if (!nom.value.trim()) { isValid = false; inputsToFlash.push(nom); }
                if (!prenom.value.trim()) { isValid = false; inputsToFlash.push(prenom); }
            }
            else if (table.id === 'PropalsTable') {
                const date = row.querySelector('input[name="date_heure"]');
                const client = row.querySelector('select[name="id_client"]');

                if (!date.value) { isValid = false; inputsToFlash.push(date); }
                if (!client.value) { isValid = false; inputsToFlash.push(client); }

                // Check tarifs count
                if (Object.keys(window.currentPropalDetails).length === 0) {
                    isValid = false;
                    // Flash the button?
                    const btn = row.querySelector('button[onclick*="showPropalDetails"]');
                    if (btn) inputsToFlash.push(btn);
                }
            }

            if (!isValid) {
                inputsToFlash.forEach(el => {
                    el.classList.add('flash-error');
                    setTimeout(() => el.classList.remove('flash-error'), 1500);
                });
            }
            return isValid;
        }

        function enterEditMode(row, editFn) {
            if (window.currentEditingRow && window.currentEditingRow !== row) {
                // Save previous row
                const table = window.currentEditingRow.closest('table');
                if (table) {
                    if (table.id === 'tarifsTable') saveTarifRow(window.currentEditingRow);
                    else if (table.id === 'clientsTable') saveClientRow(window.currentEditingRow);
                    else if (table.id === 'PropalsTable') savePropalRow(window.currentEditingRow);
                }
            }
            window.currentEditingRow = row;
            editFn();
        }

        // Inline editing for Propals
        window.currentPropalRow = null;
        window.currentPropalDetails = {};

        function addPropalRow(preselectedClientId = null) {
            console.log('addPropalRow', preselectedClientId);
            // Save/Close existing edit first
            if (window.currentEditingRow) {
                const table = window.currentEditingRow.closest('table');
                if (table) {
                    if (table.id === 'tarifsTable') saveTarifRow(window.currentEditingRow);
                    else if (table.id === 'clientsTable') saveClientRow(window.currentEditingRow);
                    else if (table.id === 'PropalsTable') savePropalRow(window.currentEditingRow);
                }
            }

            const tbody = document.querySelector('#PropalsTable tbody');
            const row = document.createElement('tr');
            row.classList.add('editing-row');

            // Définir la date par défaut à J+28 pour l'échéance ou J en date de création?
            // Le champ s'appelle 'date_heure', on suppose que c'est la date de création/émission.
            // Si c'est l'échéance, J+28 est logique. Si c'est création, J est mieux.
            // "date_heure" dans la table "suivi" du schema non fourni, mais souvent date creation.
            // Le user avait mis new Date().
            // Le user a mis plus haut J+28 dans son propre code (Step 431). Je vais respecter ça.

            const defaultDate = new Date();
            // defaultDate.setDate(defaultDate.getDate() + 28); // User requested J+28?? 
            // WAIT, Step 431 shows user added J+28 LOGIC. I will keep it.
            // Actually, for a new propal, usually it is TODAY.
            // But if user explicitly encoded J+28, maybe they meant Due Date?
            // "date_heure" name suggests timestamp.
            // I'll stick to what was there in the file content I saw in Step 431.
            // Wait, I saw lines 1173+ in Step 431 adding J+28.
            // I will preserve that default.

            const dateObj = new Date(); // Start with today
            // dateObj.setDate(dateObj.getDate() + 28); // If user wants J+28 for "date_heure"
            // Actually, let's look at Step 431 diff.
            // +            const defaultDate = new Date();
            // +            defaultDate.setDate(defaultDate.getDate() + 28);
            // +            const formattedDefaultDate = defaultDate.toISOString().slice(0, 16);
            // so yes, J+28.

            const defaultDateVal = new Date();
            defaultDateVal.setDate(defaultDateVal.getDate() + 28);
            const formattedDefaultDate = defaultDateVal.toISOString().slice(0, 16);

            row.innerHTML = `
                <td style="display:none;"><input type="text" name="id" class="form-input" disabled></td>
                <td><input type="text" name="devis_number" class="form-input" placeholder="#" disabled></td>
                <td><input type="datetime-local" name="date_heure" class="form-input" value="${formattedDefaultDate}" required></td>
                <td><input type="text" name="duree" class="form-input" placeholder="HH:MM" disabled></td>
                <td>
                    <select name="id_client" class="form-input" required onchange="updatePropalDefaults(this)">
                        <option value="">Sélectionner un client</option>
                        ${window.availableClients ? window.availableClients.map(c => `<option value="${c.id}" ${c.id == preselectedClientId ? 'selected' : ''}>${c.nom} ${c.prenom}</option>`).join('') : ''}
                    </select>
                </td>
                <td><button class="btn-icon" onclick="showPropalDetails(event)">📋</button></td>
                <td><input type="number" name="montant" class="form-input" step="0.01" placeholder="Montant" disabled></td>
                <td><input type="text" name="statut" class="form-input" value="draft" disabled></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="actions-cell">
                    <button class="btn-icon" title="Sauvegarder" onclick="savePropalRow(this.closest('tr'))">
                       <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </button>
                    <button class="btn-icon" title="Annuler" onclick="loadSuiviData()">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </td>
            `;
            tbody.prepend(row);
            window.currentPropalRow = row;
            window.currentPropalDetails = {};
            window.currentEditingRow = row;

            // Trigger default updates if client preselected
            if (preselectedClientId) {
                const select = row.querySelector('select[name="id_client"]');
                updatePropalDefaults(select);
            }

            // Ensure the new row is visible
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function createPropalForClient(clientId) {
            console.log('createPropalForClient', clientId);
            // Switch to Suivi view
            showSection('viewPropals');
            // After switching (not reloading if already loaded), add the propal row
            // If we need to load data first, wait for it
            setTimeout(() => {
                // Make sure we have the data (should be cached if section was already loaded)
                if (!window.availableClients || window.availableClients.length === 0) {
                    loadSuiviData().then(() => {
                        addPropalRow(clientId);
                    });
                } else {
                    // Data already loaded, just add the row
                    addPropalRow(clientId);
                }
            }, 100);
        }

        function editPropalRow(row, id) {
            console.log('editPropalRow', id);
            enterEditMode(row, () => {
                const data = window.propalData.find(p => p.id == id);
                if (!data) return;

                // Load existing details
                window.currentPropalDetails = {};
                try {
                    if (data.id_tarifs && typeof data.id_tarifs === 'string') {
                        window.currentPropalDetails = JSON.parse(data.id_tarifs);
                    } else if (data.id_tarifs) {
                        window.currentPropalDetails = data.id_tarifs;
                    }
                } catch (e) {
                    console.warn("Error parsing id_tarifs", e);
                }

                row.dataset.id = id;
                row.innerHTML = `
                    <td class="id">${data.id}</td>
                    <td><input type="text" name="devis_number" class="form-input" value="${data.devis_number || ''}" disabled></td>
                    <td><input type="datetime-local" name="date_heure" class="form-input" value="${data.date_heure ? new Date(data.date_heure).toISOString().slice(0, 16) : ''}" required></td>
                    <td><input type="text" name="duree" class="form-input" value="${data.duree || ''}" placeholder="HH:MM" disabled></td>
                    <td>
                        <select name="id_client" class="form-input" required onchange="updatePropalDefaults(this)">
                            <option value="">Sélectionner un client</option>
                            ${window.availableClients ? window.availableClients.map(c => `<option value="${c.id}" ${c.id == (data.id_client || '') ? 'selected' : ''}>${c.nom} ${c.prenom}</option>`).join('') : ''}
                        </select>
                    </td>
                    <td><button class="btn-icon" onclick="showPropalDetails(event)">📋</button></td>
                    <td><input type="number" name="montant" class="form-input" step="0.01" value="${data.montant || 0}" placeholder="Montant" disabled></td>
                    <td><input type="text" name="statut" class="form-input" value="${data.statut || ''}" disabled></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" name="invoice_number" class="form-input" value="${data.invoice_number || ''}" placeholder="Fact-###" disabled></td>
                    <td class="actions-cell">
                        <button class="btn-icon" title="Sauvegarder" onclick="savePropalRow(this.closest('tr'))">
                           <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </button>
                        <button class="btn-icon" title="Annuler" onclick="loadSuiviData()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </td>
                `;
                window.currentPropalRow = row;
                // updatePropalCalculations(row); // Optional: recalculate/verify totals
            });
        }

        function updatePropalDefaults(clientSelect) {
            const row = clientSelect.closest('tr');
            const clientId = clientSelect.value;

            if (!clientId) return;

            const client = window.availableClients.find(c => c.id === clientId);
            if (!client) return;

            // Only apply default if empty? Or optional logic.
            // User's previous code applied default unconditionally updatePropalDefaults.
            // I'll keep it but only if Details is empty? 
            // Previous code: `window.currentPropalDetails = {};` (clears it!).
            // If I am editing and change client, it CLEARS my details!
            // I should probably check if it's a NEW row or existing?
            // "onchange" fires when user changes it.
            // If I change client on existing propal, I probably want to keep details or reset.
            // The previous code reset it. I will stick to previous behavior.

            // Apply default tarif with quantity = client distance
            const defaultTarif = window.availableTarifs.find(t => t.default && (t.default === 'true' || t.default === 'True' || t.default === '1'));
            if (defaultTarif) {
                window.currentPropalDetails = {};
                window.currentPropalDetails[defaultTarif.id] = {
                    qtt: parseFloat(client.distance) || 1,
                    detail: ""
                };
                updatePropalCalculations(row);
            }
        }

        function showPropalDetails(event) {
            event.preventDefault();
            const row = event.target.closest('tr');
            window.currentPropalRow = row;

            // Show modal for tarif selection
            const modal = document.getElementById('invoiceItemsModal');
            if (!modal) {
                alert("Modal not found");
                return;
            }

            // Populate modal with available tarifs and current selections
            let html = '<div class="modal-content"><h3>Détails de la Propal</h3>';
            html += '<table style="width:100%"><thead><tr><th>Tarif</th><th>Qté</th><th>P.U.</th><th>Total</th></tr></thead><tbody>';

            window.availableTarifs.forEach(tarif => {
                const qtt = window.currentPropalDetails[tarif.id]?.qtt || 0;
                const prix = parseFloat(tarif.prix) || 0;
                const total = (qtt * prix).toFixed(2);
                html += `
                    <tr>
                        <td>${tarif.libelle}</td>
                        <td><input type="number" class="tarif-qtt" data-tarif-id="${tarif.id}" value="${qtt}" min="0" step="0.01" onchange="updatePropalDetails(this)"></td>
                        <td>${prix.toFixed(2)}</td>
                        <td>${total}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += '<div class="modal-actions" style="margin-top:15px;">';
            html += '<button class="btn btn-success" onclick="closeInvoiceItemsModal(); updatePropalCalculations(window.currentPropalRow)">Valider</button>';
            html += '<button class="btn btn-secondary" onclick="closeInvoiceItemsModal()">Annuler</button>';
            html += '</div></div>';

            modal.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function updatePropalDetails(input) {
            const tarifId = input.dataset.tarifId;
            const qtt = parseFloat(input.value) || 0;

            if (qtt > 0) {
                window.currentPropalDetails[tarifId] = {
                    qtt: qtt,
                    detail: ""
                };
            } else {
                delete window.currentPropalDetails[tarifId];
            }
        }

        function updatePropalCalculations(row) {
            if (!row) return;

            let totalDuree = 0;
            let totalMontant = 0;
            const idTarifs = {};

            Object.keys(window.currentPropalDetails).forEach(tarifId => {
                const detail = window.currentPropalDetails[tarifId];
                const tarif = window.availableTarifs.find(t => t.id === tarifId);

                if (tarif) {
                    idTarifs[tarifId] = detail;
                    totalMontant += (parseFloat(tarif.prix) * detail.qtt);

                    // Parse duree and multiply by quantity
                    const [hours, mins] = (tarif.timeByUnits || '00:00').split(':');
                    const mins_total = (parseInt(hours) * 60 + parseInt(mins)) * detail.qtt;
                    totalDuree += mins_total;
                }
            });

            // Format duree as HH:MM
            const hours = Math.floor(totalDuree / 60);
            const mins = totalDuree % 60;
            const dureeStr = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;

            // Update fields
            row.querySelector('input[name="duree"]').value = dureeStr;
            row.querySelector('input[name="montant"]').value = totalMontant.toFixed(2);
            row.dataset.tarifDetails = JSON.stringify(idTarifs);
        }

        async function savePropalRow(row) {
            console.log('savePropalRow');
            const id = row.dataset.id;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/suivi/${id}` : '/api/suivi';

            const payload = {
                date_heure: row.querySelector('input[name="date_heure"]').value,
                id_client: row.querySelector('select[name="id_client"]').value,
                statut: row.querySelector('input[name="statut"]').value || 'draft', // Keep existing statut if editing
                id_tarifs: window.currentPropalDetails,
                duree: row.querySelector('input[name="duree"]').value,
                montant: row.querySelector('input[name="montant"]').value
            };

            if (!payload.date_heure || !payload.id_client) {
                alert("La date et le client sont obligatoires.");
                return;
            }

            if (Object.keys(payload.id_tarifs).length === 0) {
                alert("Vous devez sélectionner au moins un tarif.");
                return;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    window.currentEditingRow = null;
                    loadSuiviData(); // Refresh table
                } else {
                    const err = await response.json();
                    alert("Erreur: " + (err.message || "Erreur inconnue"));
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Erreur réseau");
            }
        }

        // Inline editing for Clients
        function addClientRow() {
            console.log('addClientRow');
            // Save/Close existing edit first
            if (window.currentEditingRow) {
                // Trigger click outside logic or force save?
                // Simple approach: trigger the click logic check or just rely on user clicking button?
                // But button click bubbles.
                // Let's force save manually or let the listener handle it? 
                // If I click "Add Client" button, that is OUTSIDE the current row. So listener will fire and save.
                // THEN this function runs. So we should be clear.
            }

            const tbody = document.querySelector('#clientsTable tbody');
            const row = document.createElement('tr');
            row.classList.add('editing-row');
            row.innerHTML = `
                <td style="display:none;"><input type="text" name="id" class="form-input" disabled></td>
                <td><input type="text" name="nom" class="form-input" placeholder="Nom" required></td>
                <td><input type="text" name="prenom" class="form-input" placeholder="Prénom" required></td>
                <td><input type="tel" name="telephone" class="form-input" placeholder="Téléphone" pattern="[0-9]{10}"></td>
                <td><input type="email" name="email" class="form-input" placeholder="Email"></td>
                <td><input type="text" name="adresse" class="form-input" placeholder="Adresse"></td>
                <td><input type="text" name="ville" class="form-input" placeholder="Ville"></td>
                <td><input type="number" name="distance" class="form-input" step="any" placeholder="Distance (km)"></td>
                <td><input type="text" name="notes" class="form-input" placeholder="Notes"></td>
                <td><input type="checkbox" name="statut" class="form-input" checked></td>
                <td>-</td>
                <td class="actions-cell">
                    <button class="btn-icon" title="Sauvegarder" onclick="saveClientRow(this.closest('tr'))">
                       <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </button>
                    <button class="btn-icon" title="Annuler" onclick="loadClientsData()">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </td>
            `;
            tbody.prepend(row);
            window.currentEditingRow = row;
            row.querySelector('input[name="nom"]').focus();
        }

        function editClientRow(row, id) {
            console.log('editClientRow', id);
            enterEditMode(row, () => {
                const data = window.clientData.find(c => c.id == id); // Loose equality for string/int match
                if (!data) return;

                row.dataset.id = id;
                row.classList.add('editing-row');
                row.innerHTML = `
                    <td style="display:none;"><input type="text" name="id" class="form-input" value="${data.id}" disabled></td>
                    <td><input type="text" name="nom" class="form-input" value="${data.nom || ''}" required></td>
                    <td><input type="text" name="prenom" class="form-input" value="${data.prenom || ''}" required></td>
                    <td><input type="tel" name="telephone" class="form-input" value="${data.telephone || ''}"></td>
                    <td><input type="email" name="email" class="form-input" value="${data.email || ''}"></td>
                    <td><input type="text" name="adresse" class="form-input" value="${data.adresse || ''}"></td>
                    <td><input type="text" name="ville" class="form-input" value="${data.ville || ''}"></td>
                    <td><input type="number" name="distance" class="form-input" step="any" value="${data.distance || ''}"></td>
                    <td><input type="text" name="notes" class="form-input" value="${data.notes || ''}"></td>
                    <td><input type="checkbox" name="statut" class="form-input" ${data.statut === 'actif' ? 'checked' : ''}></td>
                    <td>-</td>
                    <td class="actions-cell">
                        <button class="btn-icon" title="Sauvegarder" onclick="saveClientRow(this.closest('tr'))">
                           <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </button>
                        <button class="btn-icon" title="Annuler" onclick="loadClientsData()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </td>
                `;
                // row.querySelector('input[name="nom"]').focus(); // Optional
            });
        }

        async function saveClientRow(row) {
            console.log('saveClientRow');
            const id = row.dataset.id;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/clients/${id}` : '/api/clients';

            const payload = {};
            const inputs = row.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.name && !input.disabled) {
                    if (input.type === 'checkbox') {
                        payload[input.name] = input.checked ? 'actif' : 'inactif'; // Check API expectation? 'actif'/'inactif' or 1/0?
                        // Previous code used '1'/'0'. But table view checks `item.statut === "actif"`.
                        // Let's check `addClientRow` original. It was `input.checked ? '1' : '0'`.
                        // But `populateClientsTable` checks `statut === "actif"`.
                        // The backend might handle 1/0 -> active/inactive? Or frontend map?
                        // In `populateClientsTable`: `<input type="checkbox" ${item.statut === "actif" ? "checked" : ""} disabled>`
                        // So data has 'actif'.
                        // I will send 'actif'/'inactif'.
                        // Wait, previous code (Step 274) said `payload[input.name] = input.checked ? '1' : '0';`.
                        // I should verify backend later or stick to what was there.
                        // I'll stick to 'actif'/'inactif' if possible, or '1'/'0' if backend expects bool.
                        // Let's use logic: `item.statut === "actif"`. So standard is 'actif'.
                        // The previous `saveClientRow` might have been wrong or backend is flexible.
                        // I will use `input.checked ? 'actif' : 'inactif'`.
                    } else {
                        payload[input.name] = input.value;
                    }
                }
            });
            // Fix payload logic for checkbox
            inputs.forEach(input => {
                if (input.name && !input.disabled && input.type === 'checkbox') {
                    payload[input.name] = input.checked ? 'actif' : 'inactif';
                }
            });


            if (!payload.nom || !payload.prenom) {
                alert("Le nom et le prénom sont obligatoires.");
                return;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    window.currentEditingRow = null; // Clear edit state
                    loadClientsData(); // Refresh table
                } else {
                    const err = await response.json();
                    alert("Erreur: " + (err.message || "Erreur inconnue"));
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Erreur réseau");
            }
        }

        // --- Delete Functions ---
        async function deletePropal(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) return;
            try {
                const response = await fetch(`/api/suivi/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadSuiviData();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function deleteClient(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce client ?')) return;
            try {
                const response = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadClientsData();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function deleteTarif(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce tarif ?')) return;
            try {
                const response = await fetch(`/api/tarifs/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadTarifsData();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // --- Table State Management (Sort & Column Filters) ---
        window.tableState = {
            propals: { sortCol: 'id', sortDesc: true, colFilters: {} }, // Default sort by ID desc
            clients: { sortCol: 'nom', sortDesc: false, colFilters: {} },
            tarifs: { sortCol: 'libelle', sortDesc: false, colFilters: {} }
        };

        window.handleSort = (type, col) => {
            console.log('handleSort', type, col);
            const state = window.tableState[type];
            if (state.sortCol === col) {
                state.sortDesc = !state.sortDesc;
            } else {
                state.sortCol = col;
                state.sortDesc = false;
            }
            if (type === 'propals') window.applyPropalFilters();
            else if (type === 'clients') window.applyClientFilters();
            else if (type === 'tarifs') window.applyTarifFilters();
            updateHeaderIcons(type);
        };

        window.handleColumnFilter = (type, col, input) => {
            const value = input.value.toLowerCase();
            window.tableState[type].colFilters[col] = value;
            if (type === 'propals') window.applyPropalFilters();
            else if (type === 'clients') window.applyClientFilters();
            else if (type === 'tarifs') window.applyTarifFilters();
        };

        function updateHeaderIcons(type) {
            const state = window.tableState[type];
            let tableId = 'PropalsTable';
            if (type === 'clients') tableId = 'clientsTable';
            else if (type === 'tarifs') tableId = 'tarifsTable';

            document.querySelectorAll(`#${tableId} th.sortable`).forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.col === state.sortCol) {
                    th.classList.add(state.sortDesc ? 'sort-desc' : 'sort-asc');
                }
            });
        }

        // ... (keep global filter functions, add tarifs below)

        window.applyTarifFilters = () => {
            if (!window.tarifData) return;

            let filtered = window.tarifData.filter(item => {
                // Column filters
                const colFilters = window.tableState.tarifs.colFilters;
                for (const [col, val] of Object.entries(colFilters)) {
                    if (!val) continue;
                    let itemVal = (item[col] || '').toString().toLowerCase();
                    if (!itemVal.includes(val)) return false;
                }
                return true;
            });

            // Sorting
            const { sortCol, sortDesc } = window.tableState.tarifs;
            if (sortCol) {
                filtered.sort((a, b) => {
                    let valA = a[sortCol] || '';
                    let valB = b[sortCol] || '';

                    if (sortCol === 'prix') {
                        valA = parseFloat(valA || 0);
                        valB = parseFloat(valB || 0);
                    } else {
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                    }

                    if (valA < valB) return sortDesc ? 1 : -1;
                    if (valA > valB) return sortDesc ? -1 : 1;
                    return 0;
                });
            }

            populateTarifsTable(filtered);
            updateHeaderIcons('tarifs');
        };

        // Global Filter Functions
        window.applyPropalFilters = () => {
            if (!window.propalData) return;

            // Global Filters
            const search = document.getElementById('searchPropalClientInput')?.value.toLowerCase() || '';
            const status = document.getElementById('filterPropalStatut')?.value || '';
            const dateStartInput = document.getElementById('filterPropalDateStart')?.value;
            const dateEndInput = document.getElementById('filterPropalDateEnd')?.value;
            const dateStart = dateStartInput ? new Date(dateStartInput) : null;
            const dateEnd = dateEndInput ? new Date(dateEndInput) : null;
            if (dateEnd) dateEnd.setHours(23, 59, 59, 999);

            let filtered = window.propalData.filter(item => {
                const clientName = (item.client_name || item.id_client || '').toLowerCase();
                const itemDate = new Date(item.date_heure);

                // Global checks
                if (search && !clientName.includes(search)) return false;
                if (status) {
                    const statusIdStr = status.split('-')[0];
                    const itemStatusId = mapStatusToId(item.statut);
                    if (parseInt(statusIdStr) !== itemStatusId) return false;
                }
                if (dateStart && itemDate < dateStart) return false;
                if (dateEnd && itemDate > dateEnd) return false;

                // Column Filters
                const colFilters = window.tableState.propals.colFilters;
                for (const [col, val] of Object.entries(colFilters)) {
                    if (!val) continue;
                    let itemVal = '';
                    if (col === 'client') itemVal = clientName;
                    else if (col === 'montant') itemVal = (item.montant || '').toString();
                    else if (col === 'devis_number') itemVal = (item.devis_number || '').toLowerCase();
                    else if (col === 'invoice_number') itemVal = (item.invoice_number || '').toLowerCase();
                    // Add more mappings as needed
                    else itemVal = (item[col] || '').toString().toLowerCase();

                    if (!itemVal.includes(val)) return false;
                }

                return true;
            });

            // Sorting
            const { sortCol, sortDesc } = window.tableState.propals;
            if (sortCol) {
                filtered.sort((a, b) => {
                    let valA, valB;
                    // Mappings
                    if (sortCol === 'client') { valA = a.client_name || ''; valB = b.client_name || ''; }
                    else if (sortCol === 'montant') { valA = parseFloat(a.montant || 0); valB = parseFloat(b.montant || 0); }
                    else { valA = a[sortCol] || ''; valB = b[sortCol] || ''; }

                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return sortDesc ? 1 : -1;
                    if (valA > valB) return sortDesc ? -1 : 1;
                    return 0;
                });
            }

            populateSuiviTable(filtered, window.availableTarifs || []);
            updateHeaderIcons('propals');
        };

        window.applyClientFilters = () => {
            if (!window.clientData) return;

            const search = document.getElementById('searchClientInput')?.value.toLowerCase() || '';
            const status = document.getElementById('filterClientStatut')?.value || '';

            let filtered = window.clientData.filter(client => {
                const fullName = `${client.nom || ''} ${client.prenom || ''}`.toLowerCase();

                // Global filters
                if (search && !fullName.includes(search)) return false;
                if (status && client.statut !== status) return false;

                // Column filters
                const colFilters = window.tableState.clients.colFilters;
                for (const [col, val] of Object.entries(colFilters)) {
                    if (!val) continue;
                    let itemVal = (client[col] || '').toString().toLowerCase();
                    if (!itemVal.includes(val)) return false;
                }

                return true;
            });

            // Sorting
            const { sortCol, sortDesc } = window.tableState.clients;
            if (sortCol) {
                filtered.sort((a, b) => {
                    let valA = a[sortCol] || '';
                    let valB = b[sortCol] || '';
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return sortDesc ? 1 : -1;
                    if (valA > valB) return sortDesc ? -1 : 1;
                    return 0;
                });
            }
            populateClientsTable(filtered);
            updateHeaderIcons('clients');
        };

        window.toggleFilterPopup = (e, type, col) => {
            e.stopPropagation(); // Prevent sort
            const btn = e.currentTarget;
            const th = btn.closest('th');
            const popup = th.querySelector('.filter-popup');

            // Close all other popups
            document.querySelectorAll('.filter-popup').forEach(p => {
                if (p !== popup) p.classList.add('hidden');
            });

            if (popup) {
                popup.classList.toggle('hidden');
                if (!popup.classList.contains('hidden')) {
                    popup.querySelector('input')?.focus();
                }
            }
        };

        // Close popups on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-popup') && !e.target.closest('.filter-trigger')) {
                document.querySelectorAll('.filter-popup').forEach(p => p.classList.add('hidden'));
            }
        });

        // Setup filters - Listeners
        function setupFilters() {
            // Propal Global Listeners
            document.getElementById('searchPropalClientInput')?.addEventListener('input', window.applyPropalFilters);
            document.getElementById('filterPropalStatut')?.addEventListener('change', window.applyPropalFilters);
            document.getElementById('filterPropalDateStart')?.addEventListener('change', window.applyPropalFilters);
            document.getElementById('filterPropalDateEnd')?.addEventListener('change', window.applyPropalFilters);
            document.getElementById('clearPropalFilters')?.addEventListener('click', () => {
                // Clear inputs
                document.getElementById('searchPropalClientInput').value = '';
                document.getElementById('filterPropalStatut').value = '';
                document.getElementById('filterPropalDateStart').value = '';
                document.getElementById('filterPropalDateEnd').value = '';
                // Clear column filters
                window.tableState.propals.colFilters = {};
                // Clear column filter inputs in the DOM (if they exist)
                document.querySelectorAll('#PropalsTable th input.column-filter').forEach(input => input.value = '');
                window.applyPropalFilters();
            });

            // Client Global Listeners
            document.getElementById('searchClientInput')?.addEventListener('input', window.applyClientFilters);
            document.getElementById('filterClientStatut')?.addEventListener('change', window.applyClientFilters);
            document.getElementById('clearClientFilters')?.addEventListener('click', () => {
                // Clear inputs
                document.getElementById('searchClientInput').value = '';
                document.getElementById('filterClientStatut').value = '';
                // Clear column filters
                window.tableState.clients.colFilters = {};
                // Clear column filter inputs in the DOM (if they exist)
                document.querySelectorAll('#clientsTable th input.column-filter').forEach(input => input.value = '');
                window.applyClientFilters();
            });
        }

        // Make showSection available globally
        window.showSection = showSection;
    </script>
</head>

<body>
    <header>
        <h1><span id="name"></span> (V<span id="version"></span>)</h1>
    </header>
    <nav>
        <div class="nav-spacer-left"></div>
        <button id="navPropals" class="nav-btn active" hx-on:click="showSection('viewPropals')">Suivi
            d'activite</button>
        <button id="navClients" class="nav-btn" hx-on:click="showSection('viewClients')">Clients</button>
        <button id="navTarifs" class="nav-btn" hx-on:click="showSection('viewTarifs')">Tarifs</button>
        <button id="navDashboard" class="nav-btn" hx-on:click="showSection('viewDashboard')">Tableau de Bord</button>
        <button id="navConfig" class="nav-btn" hx-on:click="showSection('viewConfig')">Config</button>
        <div class="nav-spacer-right">
            <div id="userProfileContainer" class="user-profile-container">
                <button id="userProfile" class="user-profile-btn" title="Cliquez pour vous connecter/déconnecter">
                    <svg focusable="false" height="100%" viewBox="0 0 40 40" width="100%">
                        <defs>
                            <clipPath id="avatar-clip-path">
                                <circle cx="20" cy="20" r="16"></circle>
                            </clipPath>
                        </defs>
                        <path
                            d="M4.02,28.27C2.73,25.8,2,22.98,2,20c0-2.87,0.68-5.59,1.88-8l-1.72-1.04C0.78,13.67,0,16.75,0,20c0,3.31,0.8,6.43,2.23,9.18L4.02,28.27z"
                            fill="#F6AD01"></path>
                        <path
                            d="M32.15,33.27C28.95,36.21,24.68,38,20,38c-6.95,0-12.98-3.95-15.99-9.73l-1.79,0.91C5.55,35.61,12.26,40,20,40c5.2,0,9.93-1.98,13.48-5.23L32.15,33.27z"
                            fill="#249A41"></path>
                        <path
                            d="M33.49,34.77C37.49,31.12,40,25.85,40,20c0-5.86-2.52-11.13-6.54-14.79l-1.37,1.46C35.72,9.97,38,14.72,38,20c0,5.25-2.26,9.98-5.85,13.27L33.49,34.77z"
                            fill="#3174F1"></path>
                        <path
                            d="M20,2c4.65,0,8.89,1.77,12.09,4.67l1.37-1.46C29.91,1.97,25.19,0,20,0l0,0C12.21,0,5.46,4.46,2.16,10.96L3.88,12C6.83,6.08,12.95,2,20,2"
                            fill="#E92D18"></path>
                        <image id="svgInnerImage" class="brightness" href="img/google_disconnected.png" x="4" y="4"
                            height="32" width="32" clip-path="url(#avatar-clip-path)"></image>
                    </svg>
                </button>
            </div>
        </div>
        <img id="fullscreenToggleBtn" class="brightness" src="img/expand.svg" alt="fullScreen"
            style="height: 1.3em; vertical-align: middle;">
    </nav>
    <div id="dataStatusBar">
        <span id="currentDataFolder">Mode : DEMO</span>
    </div>
    <main>
        <section id="viewPropals" class="view active">
            <div class="section-header">
                <h2>Suivi d'activite</h2>
                <button id="btnAddPropal" class="btn btn-primary" onclick="addPropalRow()">Ajouter une Propal</button>
            </div>
            <div id="PropalFormContainer" class="form-container hidden">
                <form id="PropalForm" class="form-grid compact">
                    <input type="hidden" id="PropalId">
                    <div class="form-group">
                        <label for="PropalClientIdInput">Client*</label><input type="hidden" id="PropalClientIdInput"
                            name="id_client"><select id="PropalClientSelect" name="id_client" required>
                            <option value="">Sélectionner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="PropalDate">Date*</label><input type="datetime-local" id="PropalDate"
                            name="date_heure" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/suivi" hx-target="#viewPropals"
                            hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="toggleForm('PropalFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table id="PropalsTable">
                    <thead>
                        <tr>
                            <th class="id sortable" data-col="id" onclick="handleSort('propals', 'id')">
                                <div class="th-flex">
                                    <span>id</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'propals', 'id')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('propals', 'id', this)">
                                </div>
                            </th>
                            <th class="devis_number sortable" data-col="devis_number"
                                onclick="handleSort('propals', 'devis_number')">
                                <div class="th-flex">
                                    <span>#</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'propals', 'devis_number')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('propals', 'devis_number', this)">
                                </div>
                            </th>
                            <th class="date_heure sortable" data-col="date_heure"
                                onclick="handleSort('propals', 'date_heure')">
                                <div class="th-flex">
                                    <span>Intervention</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="duree sortable" data-col="duree" onclick="handleSort('propals', 'duree')">
                                <div class="th-flex">
                                    <span>Duree</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="id_client sortable" data-col="client" onclick="handleSort('propals', 'client')">
                                <div class="th-flex">
                                    <span>Client</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'propals', 'client')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('propals', 'client', this)">
                                </div>
                            </th>
                            <th class="id_tarifs">Détails</th>
                            <th class="montant sortable" data-col="montant" onclick="handleSort('propals', 'montant')">
                                <div class="th-flex">
                                    <span>Montant</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'propals', 'montant')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('propals', 'montant', this)">
                                </div>
                            </th>
                            <th class="statut sortable" data-col="statut" onclick="handleSort('propals', 'statut')">
                                <div class="th-flex">
                                    <span>Statut</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="mode_paiement sortable" data-col="mode_paiement"
                                onclick="handleSort('propals', 'mode_paiement')">
                                <div class="th-flex">
                                    <span>Mode Paiement</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="date_paiement sortable" data-col="date_paiement"
                                onclick="handleSort('propals', 'date_paiement')">
                                <div class="th-flex">
                                    <span>Date Paiement</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="invoice_number sortable" data-col="invoice_number"
                                onclick="handleSort('propals', 'invoice_number')">
                                <div class="th-flex">
                                    <span>Facture/Devis</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'propals', 'invoice_number')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('propals', 'invoice_number', this)">
                                </div>
                            </th>
                            <th class="actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewClients" class="view">
            <div class="section-header">
                <h2>Gestion des Clients</h2>
                <button id="btnAddClient" class="btn btn-primary" onclick="addClientRow()">Ajouter un Client</button>
            </div>
            <div id="clientFormContainer" class="form-container hidden">
                <form id="clientForm" class="form-grid compact">
                    <input type="hidden" id="clientId">
                    <div class="form-group">
                        <label for="clientNom">Nom*</label><input type="text" id="clientNom" name="nom" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPrenom">Prénom*</label><input type="text" id="clientPrenom" name="prenom"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="clientTelephone">Téléphone</label><input type="tel" id="clientTelephone"
                            name="telephone" pattern="[0-9]{10}"
                            title="Le numéro de téléphone doit contenir 10 chiffres.">
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Email</label><input type="email" id="clientEmail" name="email">
                    </div>
                    <div class="form-group">
                        <label for="clientAdresse">Adresse</label><input type="text" id="clientAdresse" name="adresse">
                    </div>
                    <div class="form-group">
                        <label for="clientVille">Ville</label><input type="text" id="clientVille" name="ville">
                    </div>
                    <div class="form-group">
                        <label for="clientDistance">Distance (km)</label><input type="number" id="clientDistance"
                            name="distance" min="0" step="any">
                    </div>
                    <div class="form-group form-row">
                        <label for="clientNotes">Notes :</label><textarea id="clientNotes" name="notes"
                            rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/clients" hx-target="#viewClients"
                            hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="toggleForm('clientFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th class="id sortable" data-col="id" style="display:none;"
                                onclick="handleSort('clients', 'id')">ID</th>
                            <th class="sortable" data-col="nom" onclick="handleSort('clients', 'nom')">
                                <div class="th-flex">
                                    <span>Nom</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'nom')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'nom', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="prenom" onclick="handleSort('clients', 'prenom')">
                                <div class="th-flex">
                                    <span>Prénom</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'prenom')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'prenom', this)">
                                </div>
                            </th>
                            <th>
                                <div class="th-flex">
                                    <span>Téléphone</span>
                                    <div class="th-right">
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'telephone')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'telephone', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="email" onclick="handleSort('clients', 'email')">
                                <div class="th-flex">
                                    <span>Email</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'email')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'email', this)">
                                </div>
                            </th>
                            <th>
                                <div class="th-flex">
                                    <span>Adresse</span>
                                    <div class="th-right">
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'adresse')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'adresse', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="ville" onclick="handleSort('clients', 'ville')">
                                <div class="th-flex">
                                    <span>Ville</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'clients', 'ville')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('clients', 'ville', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="distance" onclick="handleSort('clients', 'distance')">
                                <div class="th-flex">
                                    <span>Distance (km)</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th>Notes</th>
                            <th class="status-cell sortable" data-col="statut"
                                onclick="handleSort('clients', 'statut')">
                                <div class="th-flex">
                                    <span>Actif</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="sortable" data-col="dateCreation"
                                onclick="handleSort('clients', 'dateCreation')">
                                <div class="th-flex">
                                    <span>Date Création</span>
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th class="actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewTarifs" class="view">
            <div class="section-header">
                <h2>Gestion des Tarifs</h2>
                <button id="btnAddTarif" class="btn btn-primary" type="button" onclick="addTarifRow()">Ajouter
                    un Tarif</button>
            </div>
            <div id="tarifFormContainer" class="form-container hidden">
                <form id="tarifForm" class="form-grid compact">
                    <input type="hidden" id="tarifId">
                    <div class="form-group">
                        <label for="tarifLibelle">Libellé*</label>
                        <input type="text" id="tarifLibelle" name="libelle" required>
                    </div>
                    <div class="form-group">
                        <label for="tarifPrix">Prix (€)*</label>
                        <input type="number" id="tarifPrix" name="prix" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="tarifUnit">Unité</label>
                        <input type="text" id="tarifUnit" name="Unit" placeholder="l'une, km, heure...">
                    </div>
                    <div class="form-group">
                        <label for="tarifType">Type</label>
                        <select id="tarifType" name="type">
                            <option value="Presta-BNC">Presta-BNC</option>
                            <option value="Presta-BIC">Presta-BIC</option>
                            <option value="Vente-BIC">Vente-BIC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tarifTimeByUnits">Temps/Unité</label>
                        <input type="text" id="tarifTimeByUnits" name="timeByUnits" placeholder="02:30">
                    </div>
                    <div class="form-group">
                        <label for="tarifComment">Commentaire</label>
                        <input type="text" id="tarifComment" name="Comment">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" hx-post="/api/tarifs" hx-target="#viewTarifs"
                            hx-swap="innerHTML swap:1s">Enregistrer</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="toggleForm('tarifFormContainer')">Annuler</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <table id="tarifsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-col="libelle" onclick="handleSort('tarifs', 'libelle')">
                                <div class="th-flex">
                                    <span>Libellé</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'libelle')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'libelle', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="duree" onclick="handleSort('tarifs', 'duree')">
                                <div class="th-flex">
                                    <span>Durée (min)</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'duree')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'duree', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="prix" onclick="handleSort('tarifs', 'prix')">
                                <div class="th-flex">
                                    <span>Prix (€)</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'prix')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'prix', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="unite" onclick="handleSort('tarifs', 'unite')">
                                <div class="th-flex">
                                    <span>Unité</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'unite')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'unite', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="type" onclick="handleSort('tarifs', 'type')">
                                <div class="th-flex">
                                    <span>Type</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'type')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'type', this)">
                                </div>
                            </th>
                            <th class="sortable" data-col="commentaire" onclick="handleSort('tarifs', 'commentaire')">
                                <div class="th-flex">
                                    <span>Commentaire</span>
                                    <div class="th-right">
                                        <span class="sort-icon"></span>
                                        <button class="filter-trigger"
                                            onclick="toggleFilterPopup(event, 'tarifs', 'commentaire')">☰</button>
                                    </div>
                                </div>
                                <div class="filter-popup hidden" onclick="event.stopPropagation()">
                                    <input type="text" class="column-filter" placeholder="Filtre..."
                                        oninput="handleColumnFilter('tarifs', 'commentaire', this)">
                                </div>
                            </th>
                            <th class="actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="viewDashboard" class="view">
            <div class="section-header">
                <h2>Tableau de Bord</h2>
                <img id="exportToSheetsBtn" src="./img/google_spreadsheet.png" class="sheets-icon"
                    alt="Exporter vers Google Sheets" title="Exporter vers Google Sheets">
            </div>
            <div class="dashboard-row" style="display: flex; gap: 1.2rem; flex-wrap: wrap;">
                <div class="form-container" style="flex:1 1 110px; min-width:110px;">
                    <h3>Chiffres Clés</h3>
                    <ul>
                        <li>Total Clients : <span id="statClientsCount">0</span></li>
                        <li>Total devis : <span id="statPropalsCount">0</span></li>
                        <li>Total Payées : <span id="statPropalsPayees">0</span></li>
                    </ul>
                </div>
                <div class="form-container" style="flex:1 1 130px; min-width:130px;">
                    <h3>Chiffres d'affaires</h3>
                    <ul>
                        <li>Mois Précédent : <span id="caMoisPrecedent">0.00</span> €</li>
                        <li>Mois en Cours : <span id="caMoisEnCours">0.00</span> €</li>
                        <li>Année Précédente : <span id="caAnneePrecedente">0.00</span> €</li>
                        <li>Année en Cours : <span id="caAnneeEnCours">0.00</span> €</li>
                    </ul>
                </div>
            </div>
            <div class="form-container">
                <h3>Évolution d'activite</h3>
                <div class="chart-controls" style="margin-bottom: 1rem;">
                    <label for="chartPeriodSelector">Agréger par :</label>
                    <select id="chartPeriodSelector" class="form-input"
                        style="display: inline-block; width: auto; padding: 0.375rem 0.75rem;">
                        <option value="day">Jour</option>
                        <option value="week">Semaine</option>
                        <option value="month" selected>Mois</option>
                        <option value="quarter">Trimestre</option>
                        <option value="year">Année</option>
                    </select>
                </div>
                <div id="sessionsTrendChartContainer" class="chart-container">
                    <p style="text-align:center; color:#666;">Chargement du graphique...</p>
                </div>
            </div>
        </section>

        <section id="viewConfig" class="view">
            <h2>Configuration de l'Application</h2>
            <form id="configForm" class="form-container">
                <h3>Informations du Gestionnaire</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configManagerName">Nom du gestionnaire/cabinet :</label><input type="text"
                            id="configManagerName">
                    </div>
                    <div class="form-group">
                        <label for="configManagerTitle">Titre/Profession :</label><input type="text"
                            id="configManagerTitle">
                    </div>
                    <div class="form-group form-row">
                        <label for="configManagerDescription">Description (activité) :</label><textarea
                            id="configManagerDescription" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="configManagerPhone">Téléphone :</label><input type="tel" id="configManagerPhone">
                    </div>
                    <div class="form-group">
                        <label for="configManagerEmailContact">Email de contact (affiché sur factures)</label><input
                            type="email" id="configManagerEmailContact">
                    </div>
                    <div class="form-group form-row">
                        <label for="configManagerAddress">Adresse :</label><input type="text" id="configManagerAddress">
                    </div>
                    <div class="form-group">
                        <label for="configManagerCity">Ville :</label><input type="text" id="configManagerCity">
                    </div>
                </div>
                <div class="form-group">
                    <label for="configGoogleCalendarId">ID du Calendrier Google à utiliser :</label>
                    <input type="text" id="configGoogleCalendarId" placeholder="primary (pour le calendrier principal)">
                    <small>Laissez "primary" pour utiliser le calendrier principal du compte Google connecté, ou
                        spécifiez un ID de calendrier personnalisé.</small>
                </div>
                <h3>Paramètres Financiers</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configTva">Taux de TVA (%) :</label><input type="number" id="configTva" step="0.1"
                            min="0">
                    </div>
                </div>

                <h3>Informations Légales</h3>
                <div class="form-grid config-grid">
                    <div class="form-group">
                        <label for="configSiret">SIRET :</label><input type="text" id="configSiret">
                    </div>
                    <div class="form-group">
                        <label for="configApe">Code APE :</label><input type="text" id="configApe">
                    </div>
                    <div class="form-group">
                        <label for="configAdeli">N° ADELI :</label><input type="text" id="configAdeli">
                    </div>
                    <div class="form-group form-row">
                        <label for="configIban">IBAN :</label><input type="text" id="configIban">
                    </div>
                    <div class="form-group">
                        <label for="configBic">BIC :</label><input type="text" id="configBic">
                    </div>
                </div>

                <h3>Mentions pour Factures</h3>
                <div class="form-grid config-grid">
                    <div class="form-group form-row">
                        <label for="configTvaMention">Mention TVA :</label><textarea id="configTvaMention"
                            rows="2"></textarea>
                    </div>
                    <div class="form-group form-row">
                        <label for="configPaymentTerms">Conditions de Paiement :</label><textarea
                            id="configPaymentTerms" rows="3"></textarea>
                    </div>
                    <div class="form-group form-row">
                        <label for="configInsurance">Assurance RCP :</label><textarea id="configInsurance"
                            rows="2"></textarea>
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-success">Enregistrer la Configuration</button>
                </div>

                <h3>Connexion Compte Google (pour Email & Calendrier & Sheets)</h3>
                <div id="googleAuthStatusContainer" class="form-container"
                    style="padding: 1rem; border: 1px solid #eee; margin-bottom:1.5rem;">
                    <p id="googleAuthStatusText">État de la connexion : Vérification...</p>
                    <div id="googleAuthScopes" style="font-size: 0.9em; margin-top: 0.5rem;"></div>
                    <button type="button" id="btnConnectGoogle" class="btn btn-primary"
                        style="margin-right: 10px;">Connecter mon compte Google</button>
                    <button type="button" id="btnDisconnectGoogle" class="btn btn-danger"
                        style="display:none;">Déconnecter mon compte Google</button>
                </div>
            </form>
        </section>
    </main>

    <!-- Modal de confirmation déconnexion -->
    <div id="logoutConfirmModal" class="modal hidden">
        <div class="modal-content">
            <h3>Confirmer la déconnexion</h3>
            <p>Êtes-vous sûr de vouloir vous déconnecter ?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeLogoutModal()">Annuler</button>
                <button class="btn btn-danger" onclick="confirmLogout()">Déconnexion</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-bottom" id="footer-bottom-info">
            <p>
                <span style="margin-right: 20px;"> &copy; 2025 QuickFact </span>
                <a href="https://github.com/sctfic/" target="_blank" title="GitHub"
                    style="text-decoration: none; color: inherit; margin-right: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        viewBox="0 0 16 16" style="vertical-align: text-top;">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                    </svg>
                    V<b id="version"></b>Dev by <span style="margin-left: 20px;" id="author"></span>
                </a>
                <a href="https://www.paypal.com/donate/?hosted_button_id=EQ9ALH8BUGS5S" target="_blank"
                    title="Faire un don"
                    style="text-decoration: none; color: #003087; background-color: #FFC439; margin-left: 10px; padding: 4px 12px; border-radius: 18px; display: inline-flex; align-items: center; gap: 6px; font-weight: bold; font-family: sans-serif; font-size: 0.9em; vertical-align: middle;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 48 48">
                        <g clip-path="url(#paypal_clip)">
                            <path fill="#002991"
                                d="M38.914 13.35c0 5.574-5.144 12.15-12.927 12.15H18.49l-.368 2.322L16.373 39H7.056l5.605-36h15.095c5.083 0 9.082 2.833 10.555 6.77a9.687 9.687 0 0 1 .603 3.58z" />
                            <path fill="#60CDFF"
                                d="M44.284 23.7A12.894 12.894 0 0 1 31.53 34.5h-5.206L24.157 48H14.89l1.483-9 1.75-11.178.367-2.322h7.497c7.773 0 12.927-6.576 12.927-12.15 3.825 1.974 6.055 5.963 5.37 10.35z" />
                            <path fill="#008CFF"
                                d="M38.914 13.35C37.31 12.511 35.365 12 33.248 12h-12.64L18.49 25.5h7.497c7.773 0 12.927-6.576 12.927-12.15z" />
                        </g>
                        <defs>
                            <clipPath id="paypal_clip">
                                <path fill="#fff" d="M7.056 3h37.35v45H7.056z" />
                            </clipPath>
                        </defs>
                    </svg>
                    <span>Donate/Request</span>
                </a>
            </p>
        </div>
    </footer>
    <div id="deleteConfirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="deleteModalTitle">Confirmation</h4>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Êtes-vous sûr ?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="btn btn-danger" title="Supprimer !">Supprimer</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary">Annuler</button>
            </div>
        </div>
    </div>

    <div id="invoiceItemsModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <b id="invoiceItemsModalTitle">Édition des Lignes de la Facture</b>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table id="invoiceItemsTable">
                        <thead>
                            <tr>
                                <th style="width:8%">Qtt</th>
                                <th style="width:60%">Détail</th>
                                <th style="width:20%">Prix Unitaire</th>
                                <th style="width:15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les lignes d'items seront injectées ici -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-sm btn-primary" onclick="addInvoiceItem()">Ajouter une ligne</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveItemsBtn" class="btn btn-success" onclick="saveInvoiceItems()">Enregistrer les
                    modifications</button>
            </div>
        </div>
    </div>


    <script>
        // Toggle form visibility helper
        function toggleForm(formContainerId) {
            const formContainer = document.getElementById(formContainerId);
            if (formContainer) {
                formContainer.classList.toggle('hidden');
            }
        }

        // Make toggleForm available globally
        window.toggleForm = toggleForm;
    </script>
</body>

</html>